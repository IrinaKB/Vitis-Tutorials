<table class="sphinxhide">
 <tr>
   <td align="center"><img src="https://www.xilinx.com/content/dam/xilinx/imgs/press/media-kits/corporate/xilinx-logo.png" width="30%"/><h1>2020.1 Vitis™ アプリケーション アクセラレーション開発フロー チュートリアル</h1><a href="https://github.com/Xilinx/Vitis-Tutorials/branches/all">2019.2 Vitis アプリケーション アクセラレーション開発フロー チュートリアル</a></td>
 </tr>
 <tr>
 <td>
 </td>
 </tr>
</table>

# 8\. ハードウェアでのアクセラレータの実行

これまでのすべての演習は、最適化によるパフォーマンスの向上を理解するため、ハードウェア エミュレーション モードで実行し、それと同時にシステムのビルドに必要なコンパイル時間を短縮しました。このセクションでは、前のセクションで適用した最適化をそれぞれビルドし、Alveo データセンター アクセラレータ カードのハードウェアで実行します。

各実行が終了したら、ホスト アプリケーションから表示されるパフォーマンス データを、このセクションの最後にある表に入力します。値は異なる場合があります。  
次のデータを記録します。

* **合計データ**: (`Number of Frames * Frame Size`) で計算されます。
* **合計時間**: タイムライン トレース レポートから取得します。公正に比較するため、これにはデータ転送とカーネル実行時間も含まれます。
* **スループット**: `Total Data Processed (MB)/Total Time(s)` で計算されます。

> **重要:**: この演習の手順では、それぞれハードウェア カーネルをコンパイルするので、終了するのにかなり時間がかかる可能性があります。

## ベースライン アプリケーションのハードウェアでの実行

> **重要**: `design.cfg` の `nk` オプションが 1 に設定されていることを確認します。

次のコマンドを使用して、ハードウェアでベースライン デザインをビルドおよび実行します。実行が終了すると、ホスト アプリケーションからカーネルの実行時間とスループット値が表示されます。これらの値をベンチマークとして表に入力します。

```
make run TARGET=hw STEP=baseline SOLUTION=1
```

次のメッセージが表示されます。

```
FPGA Time:       701.888 s
FPGA Throughput: 1.48762 MB/s

Processed 7.91 MB in 703.580s (1.48 MBps)
```

## メモリ転送演習のハードウェアでの実行

> **重要**: design.cfg の `nk` オプションが 1 に設定されていることを確認します。

次のコマンドを使用して、ハードウェアで localbuf バージョンのデザインを実行します。

```
make run TARGET=hw STEP=localbuf SOLUTION=1
```

ホスト アプリケーションで表示されるパフォーマンス値から、実行時間が大幅に短縮されたことがわかります。

```
FPGA Time:       86.7961 s
FPGA Throughput: 12.0298 MB/s


Processed 7.91 MB in 91.883s (11.36 MBps)
```

## 固定小数点演習のハードウェアでの実行

> **重要**: design.cfg の `nk` オプションが 1 に設定されていることを確認します。

1. fixedpoint バージョンのデザインをビルドしてハードウェアで実行します。

   ```
   make run TARGET=hw STEP=fixedpoint SOLUTION=1
   ```

2. パフォーマンス値を記録します。

   ```
   FPGA Time:       27.2872 s
   FPGA Throughput: 38.2649 MB/s

   Processed 7.91 MB in 32.290s (32.34 MBps)

   ```

## データフロー演習のハードウェアでの実行

> **重要**: design.cfg の `nk` オプションが 1 に設定されていることを確認します。

1. dataflow バージョンのデザインをビルドしてハードウェアで実行します。

   ```
   make run TARGET=hw STEP=dataflow SOLUTION=1
   ```

2. パフォーマンス値を記録します。

   ```
   FPGA Time:   3.66991 s
   FPGA Throughput: 284.514 MB/s

   Processed 7.91 MB in 7.996s (130.58 MBps)

   ```

### 複数の計算ユニット演習のハードウェアでの実行

1. ハードウェア ターゲットをビルドする前に、CU 数を 4 に設定する必要があります。これには、`design.cfg` を開いて `nk` オプションを次のように変更します。

   ```
   nk=convolve_fpga:4
   ```

2. 次のコマンドを使用して、複数の計算ユニット (multi-CU) バージョンのデザインをハードウェアで実行します。

   ```
   make run TARGET=hw STEP=multicu SOLUTION=1
   ```

   ホスト プログラムが終了すると、同様の値が表示されます。

   ```
   FPGA Time:       2.35359 s
   FPGA Throughput: 443.637 MB/s

   Processed 7.91 MB in 7.246s (144.10 MBps)
   ```

### パフォーマンス表

次の表に、最終的なパフォーマンス ベンチマーク結果を示します。

| 手順| 画像サイズ| フレーム数| 時間 (ハードウェア) (s)| スループット (MBps)
|:----------|:----------|----------:|----------:|----------:
| baseline| 1920x1080| 132| 701.8| 1.48
| localbuf| 1920x1080| 132| 86.8| 12 (8.1x)
| fixedpoint| 1920x1080| 132| 27.3| 38.2 (3.2x)
| dataflow| 1920x1080| 132| 3.6| 284 (7.4x)
| multi-CU| 1920x1080| 132| 2.35| 443 (1.5x)

## まとめ

これで、標準的な CPU ベースのアプリケーションを FPGA アクセラレーション アプリケーションに変換するすべてのモジュールを終了し、Alveo U200 アクセラレータ カードで実行したときにほぼ 300 倍のスループットを達成できました。パフォーマンスの目標を設定し、その目標を達成するためにさまざまな最適化を実行しました。

1. C アプリケーションから Vitis コア開発キット アプリケーションを作成しました。
2. ソフトウェアおよびハードウェア エミュレーション中に生成されたレポートを確認しました。
3. HLS カーネルのさまざまな最適化方法を学びました。
4. OpenCL API コマンド キューを順不同で実行するように設定し、パフォーマンスを向上する方法を学びました。
5. カーネルで複数 CU を実行するよう設定しました。
6. HLS データフロー指示子を使用し、それがアプリケーションにどのように影響するかを確認しました。
7. Alveo データセンター アクセラレータ カードで最適化したアプリケーションを実行し、パフォーマンスが実際にどれくらい向上するかを確認しました。</br>

<hr/>
<p align="center" class="sphinxhide"><b><a href="/docs/vitis-getting-started/">入門コースの初めに戻る</a> &mdash; <a href="./README.md">チュートリアルの初めに戻る</a></b></p>
<p align="center" class="sphinxhide"><sup>Copyright&copy; 2020 Xilinx</sup></p>
