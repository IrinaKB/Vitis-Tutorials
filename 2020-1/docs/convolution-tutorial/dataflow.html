


<!DOCTYPE HTML>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
	<head>
		<meta charset="utf-8">
		
		<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
		<link rel="stylesheet" href="https://static.cloud.coveo.com/searchui/v2.4382/css/CoveoFullSearch.css"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<meta name="description"/>
		<meta name="keywords"/>
		<meta property="og:title" content=""/>
		<meta property="og:description"/>
		<!-- favicon -->
		<link rel="icon" type="image/vnd.microsoft.icon" href="../_static/favicon.ico"/>
		<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../_static/favicon.ico"/>
		<!-- Fonts -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet" type="text/css"/>

  
  
  
  

  
      <script type="text/javascript" src="../_static/js/jquery.min.js"></script>	
	  <script type="text/javascript" src="../_static/js/gtm.js"></script>
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
    <script type="text/javascript" src="../_static/js/d3dd8c60ed.js"></script>
    <script type="text/javascript" src="../_static/js/common-ui-all.min.js"></script>		
    <script type="text/javascript" src="../_static/js/header-footer.min.js"></script>	
    <script type="text/javascript" src="../_static/js/jquery-ui.min.js"></script>	
    <script type="text/javascript" src="../_static/js/CoveoJsSearch.Lazy.min.js"></script>	
    <script type="text/javascript" src="../_static/js/linkid.js"></script>		
    <script type="text/javascript" src="../_static/js/Searchbox.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/common-ui-all.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/header-footer.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/pro.min.css" media="all" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
	</head>
	<body>
		<div class="xilinx-bs3"/>
		<div class="root responsivegrid">
			<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 aem-Grid--large--16 aem-Grid--xlarge--16 aem-Grid--xxlarge--16 aem-Grid--xxxlarge--16 ">
				<div class="xilinxExperienceFragments experiencefragment aem-GridColumn aem-GridColumn--default--12">
					<div class="xf-content-height">
						<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
							<div class="header parbase aem-GridColumn aem-GridColumn--default--12">
								<noindex>
									<header data-component="header">
										<nav class="navbar navbar-default aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid main-nav">
													<div class="row">
														<div class="col-xs-12">
															<div class="logo-column">
																<div class="logo">
																	<a href="https://www.xilinx.com/">
																	<img src="https://www.xilinx.com/etc.clientlibs/site/clientlibs/xilinx/all/resources/imgs/header/xilinx-header-logo.svg" title="Xilinx Inc"/>
																	</a>
																</div>
															</div>
															<div class="navbar-column">
																<div class="navbar navbar-collapse collapse" id="xilinx-main-menu">
																	<div class="mobile-search-container">
																		<div id="headerSearchBox" class="headerSearch"
																			data-component="header-search" 
																			data-redirect-if-empty="false"
																			data-coveo-access-token="xxa237d4dd-f0aa-47fc-9baa-af9121851b33"
																			data-coveo-organization-id="xilinxcomprode2rjoqok">
																			<div class='coveo-search-section'>
																				<div class="CoveoAnalytics" data-search-hub="Site"></div>
																				<ul class="dropdown-menu options">
																					<li class="option" data-label="All" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-search-hub="Site">
																						<a href="#">
																						All</a>
																					</li>
																					<li data-label="Silicon Devices" data-action-link="https://www.xilinx.com//products/silicon-devices/si-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Silicon Devices</a>
																					</li>
																					<li data-label="Boards and Kits" data-action-link="https://www.xilinx.com//products/boards-and-kits/bk-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Boards and Kits</a>
																					</li>
																					<li data-label="Intellectual Property" data-action-link="https://www.xilinx.com//products/intellectual-property/ip-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Intellectual Property</a>
																					</li>
																					<li data-label="Support" class="option" data-action-link="https://www.xilinx.com/search/support-keyword-search.html" data-search-hub="Support">
																						<a href="#">
																						Support</a>
																						<ul>
																							<li data-label="Documentation" data-action-link="https://www.xilinx.com//support/documentation-navigation/documentation-keyword-search.html" data-search-hub="Document">
																								<a href="#">
																								Documentation</a>
																							</li>
																							<li data-label="Knowledge Base" data-action-link="https://www.xilinx.com//support/answer-navigation/answer-keyword-search.html" data-search-hub="AnswerRecord">
																								<a href="#">
																								Knowledge Base</a>
																							</li>
																							<li data-label="Community Forums" data-action-link="https://www.xilinx.com/search/forums-keyword-search.html" data-search-hub="Forums">
																								<a href="#">
																								Community Forums</a>
																							</li>
																						</ul>
																					</li>
																					<li data-label="Partners" data-action-link="https://www.xilinx.com//alliance/member-keyword-search.html" data-search-hub="Partner">
																						<a href="#">
																						Partners</a>
																					</li>
																					<li data-label="Videos" data-action-link="https://www.xilinx.com/video/video-keyword-search.html" data-search-hub="Video">
																						<a href="#">
																						Videos</a>
																					</li>
																					<li data-label="Press" data-action-link="https://www.xilinx.com/search/press-keyword-search.html" data-search-hub="Press">
																						<a href="#">
																						Press</a>
																					</li>
																				</ul>
																				<a href="#" class="btn dropdown-toggle value" data-toggle="dropdown"></a>
																				<div class="CoveoSearchbox" data-id="coveosearchbox" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-placeholder="Search Xilinx"></div>
																			</div>
																		</div>
																	</div>
																	<ul class="nav navbar-nav nav-justified">
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/applications.html">
																			Applications</a> 
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/products/silicon-devices.html">
																			Products</a> 
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://developer.xilinx.com/">
																			Developers</a> 
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/support.html">
																			Support</a> 
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/about/company-overview.html">
																			About</a> 
																		</li>
																	</ul>
																</div>
															</div>
															<script type="text/javascript" src="../_static/js/gtm.js"></script>
															<!--<div class="mini-nav">
																<button type="button" data-function="xilinx-mobile-menu" id="nav-toggle" class="navbar-toggle collapsed visible-xs-block" aria-expanded="false">
																<span></span>
																<span></span>
																<span></span>
																<span></span>
																</button>
																<ul class="list-inline">
																	<li class="dropdown user-menu">
																		<button data-toggle="dropdown">
																		<span class="sr-only">Account</span>
																		<span class="fas fa-user"></span>
																		</button>
																		<ul class="dropdown-menu">
																			<li>
																				<a href="https://www.xilinx.com/myprofile/subscriptions.html">
																				My Account</a>
																			</li>
																			<li>
																				<a href="https://www.xilinx.com/registration/create-account.html">
																				Create Account</a>
																			</li>
																			<li>
																				<a href="https://www.xilinx.com/bin/protected/en/signout">
																				Sign Out</a>
																			</li>
																		</ul>
																	</li>
																	<li class="hidden-xs">
																		<button data-function="search-toggle">
																		<span class="sr-only">Search</span>
																		<span class="far fa-search"></span>
																		</button>
																	</li>
																</ul>
															</div>
															-->
															<div class="search-container">
																<div id="headerSearchBox" class="headerSearch"
																	data-component="header-search" 
																	data-redirect-if-empty="false"
																	data-coveo-access-token="xxa237d4dd-f0aa-47fc-9baa-af9121851b33"
																	data-coveo-organization-id="xilinxcomprode2rjoqok">
																	<div class='coveo-search-section'>
																		<div class="CoveoAnalytics" data-search-hub="Site"></div>
																		<ul class="dropdown-menu options">
																			<li class="option" data-label="All" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-search-hub="Site">
																				<a href="#">
																				All</a>
																			</li>
																			<li data-label="Silicon Devices" data-action-link="https://www.xilinx.com/products/silicon-devices/si-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Silicon Devices</a>
																			</li>
																			<li data-label="Boards and Kits" data-action-link="https://www.xilinx.com/products/boards-and-kits/bk-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Boards and Kits</a>
																			</li>
																			<li data-label="Intellectual Property" data-action-link="https://www.xilinx.com/products/intellectual-property/ip-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Intellectual Property</a>
																			</li>
																			<li data-label="Support" class="option" data-action-link="https://www.xilinx.com/search/support-keyword-search.html" data-search-hub="Support">
																				<a href="#">
																				Support</a>
																				<ul>
																					<li data-label="Documentation" data-action-link="https://www.xilinx.com/support/documentation-navigation/documentation-keyword-search.html" data-search-hub="Document">
																						<a href="#">
																						Documentation</a>
																					</li>
																					<li data-label="Knowledge Base" data-action-link="https://www.xilinx.com/support/answer-navigation/answer-keyword-search.html" data-search-hub="AnswerRecord">
																						<a href="#">
																						Knowledge Base</a>
																					</li>
																					<li data-label="Community Forums" data-action-link="https://www.xilinx.com/search/forums-keyword-search.html" data-search-hub="Forums">
																						<a href="#">
																						Community Forums</a>
																					</li>
																				</ul>
																			</li>
																			<li data-label="Partners" data-action-link="https://www.xilinx.com/alliance/member-keyword-search.html" data-search-hub="Partner">
																				<a href="#">
																				Partners</a>
																			</li>
																			<li data-label="Videos" data-action-link="https://www.xilinx.com/video/video-keyword-search.html" data-search-hub="Video">
																				<a href="#">
																				Videos</a>
																			</li>
																			<li data-label="Press" data-action-link="https://www.xilinx.com/search/press-keyword-search.html" data-search-hub="Press">
																				<a href="#">
																				Press</a>
																			</li>
																		</ul>
																		<a href="#" class="btn dropdown-toggle value" data-toggle="dropdown"></a>
																		<div class="CoveoSearchbox" data-id="coveosearchbox" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-placeholder="Search Xilinx"></div>
																	</div>
																</div>
																<button data-function="search-toggle">
																<span class="sr-only">Search</span>
																<span class="far fa-times"></span>
																</button>
															</div>
														</div>
													</div>
												</div>
											</div>
										</nav>
									</header>
								</noindex>
							</div>
						</div>
					</div>
				</div>
				<div class="parsys aem-GridColumn--xxxlarge--none aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
						<div class="container-fluid">
							<div class="row">
							<div class="col-xs-12">
   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../README.html" class="icon icon-home" alt="Documentation Home"> Vitis™ Application Acceleration Development Flow Tutorials
          

          
          </a>

          
            
            
              <div class="version">
                2020.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started Pathway</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vitis-getting-started/README.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vitis-execution-model/README.html">Execution Model of an FPGA Accelerated Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../alveo-getting-started/README.html">Getting Started with the Alveo Portfolio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Pathway3/README.html">Essential Concepts for Building and Running the Accelerated Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../my-first-program/README.html">My First Program</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html">Optimizing Accelerated FPGA Applications: Convolution Example</a></li>
</ul>
<p class="caption"><span class="caption-text">Intermediate</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started-rtl-kernels/README.html">Getting Started with RTL Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vitis_hls_analysis/README.html">Vitis HLS Analysis and Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mixing-c-rtl-kernels/README.html">Mixing C++ and RTL Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using-multiple-cu/README.html">Using Multiple Compute Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../host-code-opt/README.html">Host Code Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mult-ddr-banks/README.html">Using Multiple DDR Banks</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../controlling-vivado-impl/README.html">Controlling Vivado Implementation</a></li>
</ul>
<p class="caption"><span class="caption-text">Versions</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/2020-1/docs/README.html">Master</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Xilinx/Vitis-Tutorials/blob/master/README.md">2019.2</a></li>
</ul>

            
			
			<p class="caption"><span class="caption-text">This Page</span></p>
				<ul class="current">
				  <li class="toctree-l1"><a href="../_sources/convolution-tutorial/dataflow.md.txt"
						rel="nofollow">Show Source</a></li>						
				</ul>
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../README.html">Vitis™ Application Acceleration Development Flow Tutorials</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../README.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>5. Optimizing with Dataflow</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/convolution-tutorial/dataflow.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <table class="sphinxhide">
 <tr>
   <td align="center"><img src="https://www.xilinx.com/content/dam/xilinx/imgs/press/media-kits/corporate/xilinx-logo.png" width="30%"/><h1>2020.1 Vitis™ Application Acceleration Development Flow Tutorials</h1>
   <a href="https://github.com/Xilinx/Vitis-Tutorials/branches/all">See 2019.2 Vitis Application Acceleration Development Flow Tutorials</a>
   </td>
 </tr>
 <tr>
 <td>
 </td>
 </tr>
</table><div class="section" id="optimizing-with-dataflow">
<h1>5. Optimizing with Dataflow<a class="headerlink" href="#optimizing-with-dataflow" title="Permalink to this headline">¶</a></h1>
<p>In the last lab, you improved the efficiency of the kernel by using fixed point data types. In this lab, you will look at the structure of your code to increase task and instruction level parallelism. Pipelining is a common technique used by most processors to parallelize at the instruction level. Pipelining allows the processor to simultaneously process multiple instructions at the same time by executing them on hardware that has finished the previous instruction.</p>
<p>The Vitis™ compiler automatically pipelines most operations. You do not need to add anything to enable pipelining in your code. You can look at how each of the loops have been pipelined in the HLS report.</p>
<p>While pipelining usually works at the instruction level, the Vitis compiler can also pipeline at the function level using a transformation called “dataflow”. Dataflow allows you to pipeline multiple functions so that you can execute their instructions simultaneously on different sets of iterations. The following figure shows an example.</p>
<p><img alt="../_images/dataflow.png" src="../_images/dataflow.png" /></p>
<p>Without using dataflow, <code class="docutils literal notranslate"><span class="pre">func_A</span></code>, <code class="docutils literal notranslate"><span class="pre">func_B</span></code>, and <code class="docutils literal notranslate"><span class="pre">func_C</span></code> are executed sequentially. With dataflow enabled, the three functions can overlap, which will reduce the total execution time.</p>
<blockquote>
<div><p><strong>TIP</strong>: This lab relates to <a class="reference external" href="https://www.xilinx.com/cgi-bin/docs/rdoc?v=2020.1%3Bt=vitis+doc%3Bd=methodologyacceleratingapplications.html%3Ba=vhk1551127460562">Step 1: Partition the Code into a Load-Compute-Store Pattern</a> in the <a class="reference external" href="https://www.xilinx.com/cgi-bin/docs/rdoc?v=2020.1%3Bt=vitis+doc%3Bd=methodologyacceleratingapplications.html">Methodology for Accelerating Applications with the Vitis Unified Software Platform</a> in the Application Acceleration Development flow of the Vitis Unified Software Platform Documentation (UG1416).</p>
</div></blockquote>
<p>In this lab, to implement the functions in dataflow, you first divide the original convolution function into three separate functions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">read_dataflow</span></code>: Read the data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compute_dataflow</span></code>: Compute the convolution for a particular line.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">write_dataflow</span></code>: Write the output to the main memory.</p></li>
</ul>
<p>The three functions will use streams to pass data between them. To understand streams, refer <a class="reference external" href="https://www.xilinx.com/cgi-bin/docs/rdoc?v=2020.1%3Bt=vitis+doc%3Bd=hlsstreamlib.html%3Ba=mes1539734221433">HLS Stream Library</a> in the Vitis HLS flow in the Application Acceleration Development flow of the Vitis Unified Software Platform Documentation (UG1416). Streams allow you to process data at the data element level. Using streams, the next module can immediately start processing the element as soon as it is inserted into the stream variable.</p>
<div class="section" id="kernel-code-modifications">
<h2>Kernel Code Modifications<a class="headerlink" href="#kernel-code-modifications" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p><strong>TIP:</strong> The completed kernel source file is provided under the <code class="docutils literal notranslate"><span class="pre">reference-files/dataflow</span></code> folder. You can use it as a reference if needed.</p>
</div></blockquote>
<ol>
<li><p>Open the <code class="docutils literal notranslate"><span class="pre">convolve_fpga.cpp</span></code> file from <code class="docutils literal notranslate"><span class="pre">src/dataflow</span></code>.</p></li>
<li><p>First, navigate to the <code class="docutils literal notranslate"><span class="pre">convolve_fpga</span></code> function, which is the top-level function in the kernel. Modify the structure of this function to call the three sub-functions as follows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">convolve_fpga</span><span class="p">(</span><span class="n">const</span> <span class="n">RGBPixel</span><span class="o">*</span> <span class="n">inFrame</span><span class="p">,</span> <span class="n">RGBPixel</span><span class="o">*</span> <span class="n">outFrame</span><span class="p">,</span>
                   <span class="n">const</span> <span class="nb">float</span><span class="o">*</span> <span class="n">coefficient</span><span class="p">,</span> <span class="nb">int</span> <span class="n">coefficient_size</span><span class="p">,</span>
                   <span class="nb">int</span> <span class="n">img_width</span><span class="p">,</span> <span class="nb">int</span> <span class="n">img_height</span><span class="p">)</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">half</span> <span class="o">=</span> <span class="n">COEFFICIENT_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

  <span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">RGBPixel</span><span class="o">&gt;</span> <span class="n">read_stream</span><span class="p">(</span><span class="s2">&quot;read&quot;</span><span class="p">);</span>
  <span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">RGBPixel</span><span class="o">&gt;</span> <span class="n">write_stream</span><span class="p">(</span><span class="s2">&quot;write&quot;</span><span class="p">);</span>
  <span class="nb">int</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">img_width</span> <span class="o">*</span> <span class="n">img_height</span><span class="p">;</span>

<span class="c1">#pragma HLS dataflow</span>
  <span class="n">read_dataflow</span><span class="p">(</span><span class="n">read_stream</span><span class="p">,</span> <span class="n">inFrame</span><span class="p">,</span> <span class="n">img_width</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">half</span><span class="p">);</span>
  <span class="n">compute_dataflow</span><span class="p">(</span><span class="n">write_stream</span><span class="p">,</span> <span class="n">read_stream</span><span class="p">,</span> <span class="n">coefficient</span><span class="p">,</span> <span class="n">img_width</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">half</span><span class="p">);</span>
  <span class="n">write_dataflow</span><span class="p">(</span><span class="n">outFrame</span><span class="p">,</span> <span class="n">write_stream</span><span class="p">,</span> <span class="n">elements</span><span class="p">);</span>  
<span class="p">}</span>  
</pre></div>
</div>
<p>Notice that the three sub-functions are called, and the data is passed by the stream type objects <code class="docutils literal notranslate"><span class="pre">read_stream</span></code> and <code class="docutils literal notranslate"><span class="pre">write_stream</span></code>. Those streams are implemented using FIFOs on the FPGA. The DATAFLOW pragma is used so that the three functions will be executed in parallel. To understand how dataflow pragma works, refer to <em>Vivado Design Suite User Guide High-Level Synthesis</em> (<a class="reference external" href="https://www.xilinx.com/cgi-bin/docs/rdoc?v=latest%3Bd=ug902-vivado-high-level-synthesis.pdf">UG902</a>).</p>
</li>
<li><p>Next, you create the three sub-functions one by one. First, start with the <code class="docutils literal notranslate"><span class="pre">read_dataflow</span></code> function.</p>
<p>This function is created for reading data from global memory, and it passes the data to the next function using streams. To make sure that you do not read data out-of-bounds, zeros are inserted into the streams to add the padding pixels at the bottom of the image. When the line index is less than the image_height, read a line from the input image, and store it in the read_stream stream.</p>
<p>The completed function should be similar to the following.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">read_dataflow</span><span class="p">(</span><span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">RGBPixel</span><span class="o">&gt;&amp;</span> <span class="n">read_stream</span><span class="p">,</span> <span class="n">const</span> <span class="n">RGBPixel</span> <span class="o">*</span><span class="ow">in</span><span class="p">,</span>
                   <span class="nb">int</span> <span class="n">img_width</span><span class="p">,</span> <span class="nb">int</span> <span class="n">elements</span><span class="p">,</span> <span class="nb">int</span> <span class="n">half</span><span class="p">)</span> <span class="p">{</span>
<span class="nb">int</span> <span class="n">pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">while</span><span class="p">(</span><span class="n">elements</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">read_stream</span> <span class="o">&lt;&lt;</span>  <span class="ow">in</span><span class="p">[</span><span class="n">pixel</span><span class="o">++</span><span class="p">];</span>
<span class="p">}</span>
<span class="nb">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="n">img_width</span> <span class="o">*</span> <span class="n">half</span> <span class="o">+</span> <span class="n">COEFFICIENT_SIZE</span><span class="p">;</span>
<span class="k">while</span><span class="p">(</span><span class="n">padding</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">read_stream</span> <span class="o">&lt;&lt;</span> <span class="n">zero</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The hls::stream objects are defined in the <code class="docutils literal notranslate"><span class="pre">hls_stream.h</span></code> header. The <code class="docutils literal notranslate"><span class="pre">&lt;&lt;</span></code> operator is used to insert values into a stream.</p>
</li>
<li><p>Now, work on the <code class="docutils literal notranslate"><span class="pre">compute_dataflow</span></code> function. This is the most complicated function because it will read in the streaming data from <code class="docutils literal notranslate"><span class="pre">read_flow</span></code> function and compute it. The output data will be written to the <code class="docutils literal notranslate"><span class="pre">write_stream</span></code>.</p>
<p>The code snippet for <code class="docutils literal notranslate"><span class="pre">compute_dataflow</span></code> is as follows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>void compute_dataflow(hls::stream&lt;RGBPixel&gt;&amp; write_stream, hls::stream&lt;RGBPixel&gt;&amp; read_stream,
                      const float* coefficient, int img_width, int elements, int center) {
static RGBPixel window_mem[COEFFICIENT_SIZE][MAX_WIDTH];
#pragma HLS data_pack variable=window_mem
#pragma HLS array_partition variable=window_mem complete dim=1
static fixed coef[COEFFICIENT_SIZE * COEFFICIENT_SIZE];
#pragma HLS array_partition variable=coef complete

    for(int i  = 0; i &lt; COEFFICIENT_SIZE*COEFFICIENT_SIZE; i++) {
        coef[i] = coefficient[i];
    }

    int line_idx = 0;
    while(line_idx &lt; center) {
        for(int i = 0; i &lt; img_width; i++) {
            window_mem[line_idx][i] = zero;
        }
        line_idx++;
    }

    while(line_idx &lt; COEFFICIENT_SIZE - 1) {
        for(int ii = 0; ii &lt; img_width; ii++) {
            read_stream &gt;&gt; window_mem[line_idx][ii];
        }
        line_idx++;
    }

    for(int ii = 0; ii &lt; COEFFICIENT_SIZE; ii++) {
        read_stream &gt;&gt; window_mem[line_idx][ii];
    }

    int top_idx = 0;
    int insert_idx = line_idx;
    int window_line_idx = top_idx;
    int j = 0;
    int insert_column_idx = COEFFICIENT_SIZE;
    while(elements--) {
        fixed sum_r = 0, sum_g=0, sum_b=0;
        for(int m = 0; m &lt; COEFFICIENT_SIZE; ++m) {
            for(int n = 0; n &lt; COEFFICIENT_SIZE; ++n) {
                int jj = j + n - center;
                RGBPixel tmp = (jj &gt;= 0 &amp;&amp; jj &lt; img_width) ? window_mem[window_line_idx][jj] : zero;
                fixed coef_tmp = coef[m * COEFFICIENT_SIZE + n] * (jj &gt;= 0 &amp;&amp; jj &lt; img_width);
                sum_r += tmp.r * coef_tmp;
                sum_g += tmp.g * coef_tmp;
                sum_b += tmp.b * coef_tmp;
            }
            window_line_idx = ((window_line_idx + 1) == COEFFICIENT_SIZE) ? 0 : window_line_idx + 1;
        }
        window_line_idx = top_idx;
        RGBPixel out = {sum_r.to_int(), sum_g.to_int(), sum_b.to_int(), 0};
        write_stream &lt;&lt; out;
        j++;
        if(j &gt;= img_width) {
            j = 0;
            top_idx = ((top_idx + 1) == COEFFICIENT_SIZE) ? 0 : top_idx + 1;
            window_line_idx = top_idx;
        }
        read_stream &gt;&gt; window_mem[insert_idx][insert_column_idx++];
        if (insert_column_idx &gt;= img_width) {
            insert_column_idx = 0;
            insert_idx = ((insert_idx + 1) == COEFFICIENT_SIZE) ? 0 : insert_idx + 1;
        }
    }
}
</pre></div>
</div>
<p>A local buffer <code class="docutils literal notranslate"><span class="pre">window_mem</span></code> is defined to store the necessary lines of data for computing. <code class="docutils literal notranslate"><span class="pre">&gt;&gt;</span></code> operator is used to extract elements from stream. The first few lines of the <code class="docutils literal notranslate"><span class="pre">window_mem</span></code> array should be zeroed out because these represent the padding of the image. This will only be done on the first iteration.</p>
<p>The computation is implemented in the main loop, and the loop is pipelined because the COEFFICIENT_SIZE variable is predefined at the compile time. For more details about optimizing loops, refer to <a class="reference external" href="https://www.xilinx.com/cgi-bin/docs/ndoc?v=2020.1%3Bt=https:%3Bd=methodologyacceleratingapplications.html%3Ba=wnz1555544738414">Step 4: Improve Loop Latencies</a> in <a class="reference external" href="https://www.xilinx.com/cgi-bin/docs/rdoc?v=2020.1%3Bt=vitis+doc%3Bd=methodologyacceleratingapplications.html">Methodology for Accelerating Applications with the Vitis Unified Software Platform</a> in the Application Acceleration Development flow of the Vitis Unified Software Platform Documentation (UG1416).</p>
<p>After computation, the <code class="docutils literal notranslate"><span class="pre">out</span></code> value is pushed to a <code class="docutils literal notranslate"><span class="pre">write_stream</span></code> for the downstream function to process.</p>
</li>
<li><p>Now, look at the <code class="docutils literal notranslate"><span class="pre">write_dataflow</span></code> function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">write_dataflow</span><span class="p">(</span><span class="n">RGBPixel</span><span class="o">*</span> <span class="n">outFrame</span><span class="p">,</span> <span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">RGBPixel</span><span class="o">&gt;&amp;</span> <span class="n">write_stream</span><span class="p">,</span>
                    <span class="nb">int</span> <span class="n">elements</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">int</span> <span class="n">pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="n">elements</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">write_stream</span> <span class="o">&gt;&gt;</span> <span class="n">outFrame</span><span class="p">[</span><span class="n">pixel</span><span class="o">++</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This function is quite simple. It just outputs the streaming results to the global memory.</p>
</li>
</ol>
</div>
<div class="section" id="run-hardware-emulation-for-dataflow">
<h2>Run Hardware Emulation for Dataflow<a class="headerlink" href="#run-hardware-emulation-for-dataflow" title="Permalink to this headline">¶</a></h2>
<p>Go to the <code class="docutils literal notranslate"><span class="pre">makefile</span></code> directory and use the following command to run hardware emulation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">run</span> <span class="n">TARGET</span><span class="o">=</span><span class="n">hw_emu</span> <span class="n">STEP</span><span class="o">=</span><span class="n">dataflow</span> <span class="n">SOLUTION</span><span class="o">=</span><span class="mi">1</span> <span class="n">NUM_FRAMES</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>You should see the following results.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Processed</span> <span class="mf">0.02</span> <span class="n">MB</span> <span class="ow">in</span> <span class="mf">29.728</span><span class="n">s</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">MBps</span><span class="p">)</span>

<span class="n">INFO</span><span class="p">:</span> <span class="p">[</span><span class="n">Vitis</span><span class="o">-</span><span class="n">EM</span> <span class="mi">22</span><span class="p">]</span> <span class="p">[</span><span class="n">Wall</span> <span class="n">clock</span> <span class="n">time</span><span class="p">:</span> <span class="mi">23</span><span class="p">:</span><span class="mi">03</span><span class="p">,</span> <span class="n">Emulation</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.108257</span> <span class="n">ms</span><span class="p">]</span> <span class="n">Data</span> <span class="n">transfer</span> <span class="n">between</span> <span class="n">kernel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="k">global</span> <span class="n">memory</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">convolve_fpga_1</span><span class="p">:</span><span class="n">m_axi_gmem1</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">20.000</span> <span class="n">KB</span>              <span class="n">WR</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>
<span class="n">convolve_fpga_1</span><span class="p">:</span><span class="n">m_axi_gmem2</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>               <span class="n">WR</span> <span class="o">=</span> <span class="mf">20.000</span> <span class="n">KB</span>
<span class="n">convolve_fpga_1</span><span class="p">:</span><span class="n">m_axi_gmem3</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">0.035</span> <span class="n">KB</span>               <span class="n">WR</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>
</pre></div>
</div>
</div>
<div class="section" id="view-the-profile-summary-report-for-hardware-emulation">
<h2>View the Profile Summary Report for Hardware Emulation<a class="headerlink" href="#view-the-profile-summary-report-for-hardware-emulation" title="Permalink to this headline">¶</a></h2>
<p>Use the following command to view the Profile Summary report.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">view_run_summary</span> <span class="n">TARGET</span><span class="o">=</span><span class="n">hw_emu</span> <span class="n">STEP</span><span class="o">=</span><span class="n">dataflow</span>
</pre></div>
</div>
<p>The kernel execution time is now reduced to 0.059 ms.</p>
<p>Here is the updated table.</p>
<p>| Step               | Image Size | Time (HW-EM)(ms) | Reads(KB)       | Writes(KB) | Avg. Read (KB) | Avg. Write (KB) | Bandwidth (MBps)  |
| :—————   | :——— | —————: | ————–: | ———: | ————-: | ————–: | ———: |
| baseline           |     512x10 | 3.903            | 344             |       20.0 |          0.004 |           0.004 |    5.2     |
| localbuf           |     512x10 | 1.574 (2.48x)    | 21  (0.12x)     |       20.0 |          0.064 |           0.064 |    13      |
| fixed-point data   |     512x10 | 0.46 (3.4x)      | 21              |       20.0 |          0.064 |           0.064 |    44      |
| dataflow           |     512x10 | 0.059 (7.8x)     | 21              |       20.0 |          0.064 |           0.064 |    347     |</p>
</div>
<div class="section" id="next-step">
<h2>Next Step<a class="headerlink" href="#next-step" title="Permalink to this headline">¶</a></h2>
<p>You have performed a couple of optimizations on the hardware kernels to improve the performance. In the next section, you look at different host code optimizations, such as <a class="reference internal" href="multi-CU.html"><span class="doc">using out-of-order queues and multiple compute units</span></a>.</p>
<p></br></p>
<hr/>
<p align="center" class="sphinxhide"><b><a href="/docs/vitis-getting-started/README.md">Return to Getting Started Pathway</a> — <a href="/docs/convolution-tutorial/README.md">Return to Start of Tutorial</a></b></p><p align="center" class="sphinxhide"><sup>Copyright&copy; 2020 Xilinx</sup></p></div>
</div>


           </div>
           
          </div>
          <footer>
<!-- Atalwar: Moved the footer code to layout.html to resolve conflict with the Xilinx template -->
</footer>

        </div>
      </div>
	  
	  
	  <!-- Sphinx Page Footer block -->
  

  <hr/>

  <div role="contentinfo" class="copyright">
    <p class="footerinfo">
      <span class="lastupdated">
        Last updated on July 23, 2020.
      </span>

    </p>
  </div>	  
      </div>
    </section>


  




  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

   <script type="text/javascript">
    jQuery(function() { Search.loadIndex("searchindex.js"); });
  </script>

  <script type="text/javascript" id="searchindexloader"></script>     	    
	    
	    
  
  
    
  
  

  
  <!--  Xilinx template footer block -->
							</div>
						</div>
					</div>
				</div>
				<div class="xilinxExperienceFragments experiencefragment aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
					<div class="xf-content-height">
						<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
							<div class="footer parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
								<noindex>
									<footer>
										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">
													<div class="row">
														<div class="footerSocial parbase">
															<div class="col-md-push-6 col-lg-push-6 col-md-6 col-lg-6">
																<ul class="list-inline pull-right social-menu">
																	<li>
																		<a href="https://www.linkedin.com/company/xilinx">
																		<span class="linkedin icon"></span>
																		<span class="sr-only">Connect on LinkedIn</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.twitter.com/XilinxInc">
																		<span class="twitter icon"></span>
																		<span class="sr-only">Follow us on Twitter</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.facebook.com/XilinxInc">
																		<span class="facebook icon"></span>
																		<span class="sr-only">Connect on Facebook</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.youtube.com/XilinxInc">
																		<span class="youtube icon"></span>
																		<span class="sr-only">Watch us on YouTube</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.xilinx.com/registration/subscriber-signup.html">
																		<span class="newsletter icon"></span>
																		<span class="sr-only">Subscribe to Newsletter</span>
																		</a>
																	</li>
																</ul>
															</div>
														</div>
														<div class="col-md-pull-6 col-lg-pull-6 col-md-6 col-lg-6">
															<span class="copyright">
                                  
                                  &copy; 2020, Xilinx
                              </span>
															<ul class="list-inline sub-menu">
																<li>
																	<a href="https://www.xilinx.com/about/privacy-policy.html">Privacy</a>
																</li>
																<li>
																	<a href="https://www.xilinx.com/about/legal.html">Legal</a>
																</li>
																<li>
																	<a href="https://www.xilinx.com/about/contact.html">Contact</a>
																</li>
															</ul>
														</div>
													</div>
												</div>
											</div>
										</div>
									</footer>
								</noindex>
							</div>
						</div>
					</div>
				</div>
				<div class="quicklinks parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
					<noindex>
						<span class="quickLinks">
							<ul>
								<li>
									<a href="#top" class="btn backToTop">
									<span class="fas fa-angle-up" aria-hidden="true"></span>
									</a>
								</li>
							</ul>
						</span>
					</noindex>
				</div>
			</div>
		</div>
		<script>window.CQ = window.CQ || {}</script>
		<script src="https://static.cloud.coveo.com/searchui/v2.4382/js/CoveoJsSearch.Lazy.min.js"></script>
		<script>
			var underscoreSetup = function () {
			  _.templateSettings.interpolate = /\{\{=([^-][\S\s]+?)\}\}/g;
			  _.templateSettings.evaluate = /\{\{([^-=][\S\s]+?)\}\}/g;
			  _.templateSettings.escape = /\{\{-([^=][\S\s]+?)\}\}/g;
			}
			
			underscoreSetup();
		</script>
	</body>
</html>