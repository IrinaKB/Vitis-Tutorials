


<!DOCTYPE HTML>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
	<head>
		<meta charset="utf-8">
		
		<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
		<link rel="stylesheet" href="https://static.cloud.coveo.com/searchui/v2.4382/css/CoveoFullSearch.css"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<meta name="description"/>
		<meta name="keywords"/>
		<meta property="og:title" content=""/>
		<meta property="og:description"/>
		<!-- favicon -->
		<link rel="icon" type="image/vnd.microsoft.icon" href="../_static/favicon.ico"/>
		<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../_static/favicon.ico"/>
		<!-- Fonts -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet" type="text/css"/>

  
  
  
  

  
      <script type="text/javascript" src="../_static/js/jquery.min.js"></script>	
	  <script type="text/javascript" src="../_static/js/gtm.js"></script>
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
    <script type="text/javascript" src="../_static/js/d3dd8c60ed.js"></script>
    <script type="text/javascript" src="../_static/js/common-ui-all.min.js"></script>		
    <script type="text/javascript" src="../_static/js/header-footer.min.js"></script>	
    <script type="text/javascript" src="../_static/js/jquery-ui.min.js"></script>	
    <script type="text/javascript" src="../_static/js/CoveoJsSearch.Lazy.min.js"></script>	
    <script type="text/javascript" src="../_static/js/linkid.js"></script>		
    <script type="text/javascript" src="../_static/js/Searchbox.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/common-ui-all.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/header-footer.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/pro.min.css" media="all" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
	</head>
	<body>
		<div class="xilinx-bs3"/>
		<div class="root responsivegrid">
			<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 aem-Grid--large--16 aem-Grid--xlarge--16 aem-Grid--xxlarge--16 aem-Grid--xxxlarge--16 ">
				<div class="xilinxExperienceFragments experiencefragment aem-GridColumn aem-GridColumn--default--12">
					<div class="xf-content-height">
						<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
							<div class="header parbase aem-GridColumn aem-GridColumn--default--12">
								<noindex>
									<header data-component="header">
										<nav class="navbar navbar-default aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid main-nav">
													<div class="row">
														<div class="col-xs-12">
															<div class="logo-column">
																<div class="logo">
																	<a href="https://www.xilinx.com/">
																	<img src="https://www.xilinx.com/etc.clientlibs/site/clientlibs/xilinx/all/resources/imgs/header/xilinx-header-logo.svg" title="Xilinx Inc"/>
																	</a>
																</div>
															</div>
															<div class="navbar-column">
																<div class="navbar navbar-collapse collapse" id="xilinx-main-menu">
																	<div class="mobile-search-container">
																		<div id="headerSearchBox" class="headerSearch"
																			data-component="header-search" 
																			data-redirect-if-empty="false"
																			data-coveo-access-token="xxa237d4dd-f0aa-47fc-9baa-af9121851b33"
																			data-coveo-organization-id="xilinxcomprode2rjoqok">
																			<div class='coveo-search-section'>
																				<div class="CoveoAnalytics" data-search-hub="Site"></div>
																				<ul class="dropdown-menu options">
																					<li class="option" data-label="All" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-search-hub="Site">
																						<a href="#">
																						All</a>
																					</li>
																					<li data-label="Silicon Devices" data-action-link="https://www.xilinx.com//products/silicon-devices/si-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Silicon Devices</a>
																					</li>
																					<li data-label="Boards and Kits" data-action-link="https://www.xilinx.com//products/boards-and-kits/bk-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Boards and Kits</a>
																					</li>
																					<li data-label="Intellectual Property" data-action-link="https://www.xilinx.com//products/intellectual-property/ip-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Intellectual Property</a>
																					</li>
																					<li data-label="Support" class="option" data-action-link="https://www.xilinx.com/search/support-keyword-search.html" data-search-hub="Support">
																						<a href="#">
																						Support</a>
																						<ul>
																							<li data-label="Documentation" data-action-link="https://www.xilinx.com//support/documentation-navigation/documentation-keyword-search.html" data-search-hub="Document">
																								<a href="#">
																								Documentation</a>
																							</li>
																							<li data-label="Knowledge Base" data-action-link="https://www.xilinx.com//support/answer-navigation/answer-keyword-search.html" data-search-hub="AnswerRecord">
																								<a href="#">
																								Knowledge Base</a>
																							</li>
																							<li data-label="Community Forums" data-action-link="https://www.xilinx.com/search/forums-keyword-search.html" data-search-hub="Forums">
																								<a href="#">
																								Community Forums</a>
																							</li>
																						</ul>
																					</li>
																					<li data-label="Partners" data-action-link="https://www.xilinx.com//alliance/member-keyword-search.html" data-search-hub="Partner">
																						<a href="#">
																						Partners</a>
																					</li>
																					<li data-label="Videos" data-action-link="https://www.xilinx.com/video/video-keyword-search.html" data-search-hub="Video">
																						<a href="#">
																						Videos</a>
																					</li>
																					<li data-label="Press" data-action-link="https://www.xilinx.com/search/press-keyword-search.html" data-search-hub="Press">
																						<a href="#">
																						Press</a>
																					</li>
																				</ul>
																				<a href="#" class="btn dropdown-toggle value" data-toggle="dropdown"></a>
																				<div class="CoveoSearchbox" data-id="coveosearchbox" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-placeholder="Search Xilinx"></div>
																			</div>
																		</div>
																	</div>
																	<ul class="nav navbar-nav nav-justified">
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/applications.html">
																			Applications</a> 
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/products/silicon-devices.html">
																			Products</a> 
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://developer.xilinx.com/">
																			Developers</a> 
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/support.html">
																			Support</a> 
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/about/company-overview.html">
																			About</a> 
																		</li>
																	</ul>
																</div>
															</div>
															<script type="text/javascript" src="../_static/js/gtm.js"></script>
															<!--<div class="mini-nav">
																<button type="button" data-function="xilinx-mobile-menu" id="nav-toggle" class="navbar-toggle collapsed visible-xs-block" aria-expanded="false">
																<span></span>
																<span></span>
																<span></span>
																<span></span>
																</button>
																<ul class="list-inline">
																	<li class="dropdown user-menu">
																		<button data-toggle="dropdown">
																		<span class="sr-only">Account</span>
																		<span class="fas fa-user"></span>
																		</button>
																		<ul class="dropdown-menu">
																			<li>
																				<a href="https://www.xilinx.com/myprofile/subscriptions.html">
																				My Account</a>
																			</li>
																			<li>
																				<a href="https://www.xilinx.com/registration/create-account.html">
																				Create Account</a>
																			</li>
																			<li>
																				<a href="https://www.xilinx.com/bin/protected/en/signout">
																				Sign Out</a>
																			</li>
																		</ul>
																	</li>
																	<li class="hidden-xs">
																		<button data-function="search-toggle">
																		<span class="sr-only">Search</span>
																		<span class="far fa-search"></span>
																		</button>
																	</li>
																</ul>
															</div>
															-->
															<div class="search-container">
																<div id="headerSearchBox" class="headerSearch"
																	data-component="header-search" 
																	data-redirect-if-empty="false"
																	data-coveo-access-token="xxa237d4dd-f0aa-47fc-9baa-af9121851b33"
																	data-coveo-organization-id="xilinxcomprode2rjoqok">
																	<div class='coveo-search-section'>
																		<div class="CoveoAnalytics" data-search-hub="Site"></div>
																		<ul class="dropdown-menu options">
																			<li class="option" data-label="All" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-search-hub="Site">
																				<a href="#">
																				All</a>
																			</li>
																			<li data-label="Silicon Devices" data-action-link="https://www.xilinx.com/products/silicon-devices/si-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Silicon Devices</a>
																			</li>
																			<li data-label="Boards and Kits" data-action-link="https://www.xilinx.com/products/boards-and-kits/bk-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Boards and Kits</a>
																			</li>
																			<li data-label="Intellectual Property" data-action-link="https://www.xilinx.com/products/intellectual-property/ip-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Intellectual Property</a>
																			</li>
																			<li data-label="Support" class="option" data-action-link="https://www.xilinx.com/search/support-keyword-search.html" data-search-hub="Support">
																				<a href="#">
																				Support</a>
																				<ul>
																					<li data-label="Documentation" data-action-link="https://www.xilinx.com/support/documentation-navigation/documentation-keyword-search.html" data-search-hub="Document">
																						<a href="#">
																						Documentation</a>
																					</li>
																					<li data-label="Knowledge Base" data-action-link="https://www.xilinx.com/support/answer-navigation/answer-keyword-search.html" data-search-hub="AnswerRecord">
																						<a href="#">
																						Knowledge Base</a>
																					</li>
																					<li data-label="Community Forums" data-action-link="https://www.xilinx.com/search/forums-keyword-search.html" data-search-hub="Forums">
																						<a href="#">
																						Community Forums</a>
																					</li>
																				</ul>
																			</li>
																			<li data-label="Partners" data-action-link="https://www.xilinx.com/alliance/member-keyword-search.html" data-search-hub="Partner">
																				<a href="#">
																				Partners</a>
																			</li>
																			<li data-label="Videos" data-action-link="https://www.xilinx.com/video/video-keyword-search.html" data-search-hub="Video">
																				<a href="#">
																				Videos</a>
																			</li>
																			<li data-label="Press" data-action-link="https://www.xilinx.com/search/press-keyword-search.html" data-search-hub="Press">
																				<a href="#">
																				Press</a>
																			</li>
																		</ul>
																		<a href="#" class="btn dropdown-toggle value" data-toggle="dropdown"></a>
																		<div class="CoveoSearchbox" data-id="coveosearchbox" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-placeholder="Search Xilinx"></div>
																	</div>
																</div>
																<button data-function="search-toggle">
																<span class="sr-only">Search</span>
																<span class="far fa-times"></span>
																</button>
															</div>
														</div>
													</div>
												</div>
											</div>
										</nav>
									</header>
								</noindex>
							</div>
						</div>
					</div>
				</div>
				<div class="parsys aem-GridColumn--xxxlarge--none aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
						<div class="container-fluid">
							<div class="row">
							<div class="col-xs-12">
   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../README.html" class="icon icon-home" alt="Documentation Home"> Vitis™ Application Acceleration Development Flow Tutorials
          

          
          </a>

          
            
            
              <div class="version">
                2020.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started Pathway</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vitis-getting-started/README.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vitis-execution-model/README.html">Execution Model of an FPGA Accelerated Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../alveo-getting-started/README.html">Getting Started with the Alveo Portfolio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Pathway3/README.html">Essential Concepts for Building and Running the Accelerated Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../my-first-program/README.html">My First Program</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html">Optimizing Accelerated FPGA Applications: Convolution Example</a></li>
</ul>
<p class="caption"><span class="caption-text">Intermediate</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started-rtl-kernels/README.html">Getting Started with RTL Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vitis_hls_analysis/README.html">Vitis HLS Analysis and Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mixing-c-rtl-kernels/README.html">Mixing C++ and RTL Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using-multiple-cu/README.html">Using Multiple Compute Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../host-code-opt/README.html">Host Code Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mult-ddr-banks/README.html">Using Multiple DDR Banks</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../controlling-vivado-impl/README.html">Controlling Vivado Implementation</a></li>
</ul>
<p class="caption"><span class="caption-text">Versions</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/2020-1/docs/README.html">Master</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Xilinx/Vitis-Tutorials/blob/master/README.md">2019.2</a></li>
</ul>

            
			
			<p class="caption"><span class="caption-text">This Page</span></p>
				<ul class="current">
				  <li class="toctree-l1"><a href="../_sources/convolution-tutorial/qdma.md.txt"
						rel="nofollow">Show Source</a></li>						
				</ul>
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../README.html">Vitis™ Application Acceleration Development Flow Tutorials</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../README.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>7. Using QDMA Streaming with Multiple Compute Units</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/convolution-tutorial/qdma.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <table class="sphinxhide">
 <tr>
   <td align="center"><img src="https://www.xilinx.com/content/dam/xilinx/imgs/press/media-kits/corporate/xilinx-logo.png" width="30%"/><h1>2020.1 Vitis™ Application Acceleration Development Flow Tutorials</h1>
   <a href="https://github.com/Xilinx/Vitis-Tutorials/branches/all">See 2019.2 Vitis Application Acceleration Development Flow Tutorials</a>
   </td>
 </tr>
 <tr>
 <td>
 </td>
 </tr>
</table><div class="section" id="using-qdma-streaming-with-multiple-compute-units">
<h1>7. Using QDMA Streaming with Multiple Compute Units<a class="headerlink" href="#using-qdma-streaming-with-multiple-compute-units" title="Permalink to this headline">¶</a></h1>
<p>In this section, you will modify the design to use multiple CUs with streaming functionality based on the output from the previous lab.</p>
<blockquote>
<div><p><strong>TIP:</strong> The completed kernel source file is provided in the <code class="docutils literal notranslate"><span class="pre">reference-files/qdma</span></code> folder if needed.</p>
</div></blockquote>
<blockquote>
<div><p><strong>IMPORTANT:</strong> Before diving into the code transformation, some of the header files: <code class="docutils literal notranslate"><span class="pre">types.h</span></code> and <code class="docutils literal notranslate"><span class="pre">kernel.h</span></code>, <code class="docutils literal notranslate"><span class="pre">xcl2.hpp</span></code> and <code class="docutils literal notranslate"><span class="pre">xcl2.cpp</span></code> and <code class="docutils literal notranslate"><span class="pre">kernel_types.h</span></code> (new file) are added/changed from the previous step to separate the host and kernel code function/struct definitions.</p>
</div></blockquote>
<p>In this step, you must make both the code and kernel code transformations.</p>
<p>Open the <code class="docutils literal notranslate"><span class="pre">convolve.cpp</span></code> host code file from <code class="docutils literal notranslate"><span class="pre">src/qdma</span></code>, and make the following modifications.</p>
<p>In the previous step, you developed kernel code to divide the image into a partition, so each CU can work on an individual portion in parallel. In this step, each CU will be associated with a stream interface, so you need to partition the image on the host, so the data can be sent accordingly to the device.</p>
<div class="section" id="initialize-the-device">
<h2>Initialize the Device<a class="headerlink" href="#initialize-the-device" title="Permalink to this headline">¶</a></h2>
<p>In this step, you must set and create the stream classes. As you work through this section, refer to step 1 in the host code. This typically involves the following steps:</p>
<ul class="simple">
<li><p>Declare the kernel streaming class and the streaming APIs.</p></li>
<li><p>Create kernel objects for each CU.</p></li>
<li><p>Initialize the streaming classes.</p></li>
<li><p>Create streams for the CUs.</p></li>
</ul>
<ol>
<li><p>Declare the classes for <code class="docutils literal notranslate"><span class="pre">mem_ext_ptr</span></code> and the custom stream APIs that binds to Xilinx Streaming APIs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;CL/cl_ext_xilinx.h&quot;</span>

<span class="n">decltype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clCreateStream</span><span class="p">)</span> <span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">createStream</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
<span class="n">decltype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clReleaseStream</span><span class="p">)</span> <span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">releaseStream</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
<span class="n">decltype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clReadStream</span><span class="p">)</span> <span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">readStream</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
<span class="n">decltype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clWriteStream</span><span class="p">)</span> <span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">writeStream</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
<span class="n">decltype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clPollStreams</span><span class="p">)</span> <span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">pollStreams</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Associate each streaming interface  with a unique kernel <code class="docutils literal notranslate"><span class="pre">cl_kernel</span></code> object for each CU.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="p">::</span><span class="n">string</span> <span class="n">krnl_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">kernel_name</span><span class="p">;</span>
<span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cl</span><span class="p">::</span><span class="n">Kernel</span><span class="o">&gt;</span> <span class="n">convolve_kernel</span><span class="p">(</span><span class="n">NCU</span><span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NCU</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
            <span class="n">cu_id</span> <span class="o">=</span> <span class="n">std</span><span class="p">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">auto</span> <span class="n">krnl_name_full</span> <span class="o">=</span> <span class="n">krnl_name</span> <span class="o">+</span><span class="s2">&quot;:{&quot;</span> <span class="o">+</span> <span class="s2">&quot;convolve_fpga_&quot;</span> <span class="o">+</span> <span class="n">cu_id</span> <span class="o">+</span><span class="s2">&quot;}&quot;</span> <span class="p">;</span>
            <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Creating a kernel [</span><span class="si">%s</span><span class="s2">] for CU(</span><span class="si">%d</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">krnl_name_full</span><span class="o">.</span><span class="n">c_str</span><span class="p">(),</span>
                    <span class="n">i</span><span class="p">);</span>
            <span class="n">convolve_kernel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span><span class="p">::</span><span class="n">Kernel</span><span class="p">(</span>
                            <span class="n">program</span><span class="p">,</span> <span class="n">krnl_name_full</span><span class="o">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Before using the streaming interface on the host, the streaming class needs to be initialized with the platform. The device info is available from <code class="docutils literal notranslate"><span class="pre">device.getInfo</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">auto</span> <span class="n">platform_id</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">getInfo</span><span class="o">&lt;</span><span class="n">CL_DEVICE_PLATFORM</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>

<span class="o">//</span><span class="n">Initialization</span> <span class="n">of</span> <span class="n">streaming</span> <span class="k">class</span> <span class="nc">is</span> <span class="n">needed</span> <span class="n">before</span> <span class="n">using</span> <span class="n">it</span><span class="o">.</span>
<span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">init</span><span class="p">(</span><span class="n">platform_id</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Looking at the kernel interface, the three function arguments that are mapped to AXI can be converted into streams. Create three streams for each CU.</p>
<p>Each of the streams should be directly attached to the OpenCL device object because it does not use any command queue. A stream itself is a command queue that only passes the data in a particular direction, either from host to kernel or from kernel to host.</p>
<ul>
<li><p>The first step is creating the stream using the <code class="docutils literal notranslate"><span class="pre">clcreatestream</span></code> which take five arguments:</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">device_id</span></code></strong>: Device handle on which the stream will be created.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">flags</span></code></strong>: An appropriate flag should be used to denote the stream as XCL_STREAM_READ_ONLY or XCL_STREAM_WRITE_ONLY from the perspective of the kernel program.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">attributes</span></code></strong>: Attributes of the requested stream.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">ext</span></code></strong>: Specify how the stream is connected to the device, a Xilinx extension pointer object (cl_mem_ext_ptr_t) is used to identify the kernel, and the kernel argument the stream is associated with. The <code class="docutils literal notranslate"><span class="pre">ext.flag</span></code> is used to communicate to the respective kernel argument</p>
<ul>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">ext.param</span></code></strong>: Specify the kernel name.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">ext.flags</span></code></strong>: Specify to which kernel argument the stream has to connected.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">ext.obj</span></code></strong>: Set to null.</p></li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">errcode_ret</span></code></strong>: Return value (for example, CL_SUCCESS).</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Streams</span>
<span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cl_stream</span><span class="o">&gt;</span> <span class="n">write_stream_a</span><span class="p">(</span><span class="n">NCU</span><span class="p">);</span>
<span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cl_stream</span><span class="o">&gt;</span> <span class="n">write_stream_b</span><span class="p">(</span><span class="n">NCU</span><span class="p">);</span>
<span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cl_stream</span><span class="o">&gt;</span> <span class="n">read_stream</span><span class="p">(</span><span class="n">NCU</span><span class="p">);</span>
<span class="n">cl_int</span> <span class="n">ret</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NCU</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">//</span> <span class="n">Device</span> <span class="n">Connection</span> <span class="n">specification</span> <span class="n">of</span> <span class="n">the</span> <span class="n">stream</span> <span class="n">through</span> <span class="n">extension</span> <span class="n">pointer</span>
        <span class="n">cl_mem_ext_ptr_t</span> <span class="n">ext</span><span class="p">;</span>
        <span class="n">ext</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">convolve_kernel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">();</span>
        <span class="n">ext</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">The</span> <span class="o">.</span><span class="n">flag</span> <span class="n">should</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">denote</span> <span class="n">the</span> <span class="n">kernel</span> <span class="n">argument</span>
        <span class="o">//</span> <span class="n">Create</span> <span class="n">write</span> <span class="n">stream</span> <span class="k">for</span> <span class="n">argument</span> <span class="mi">0</span> <span class="ow">and</span> <span class="mi">1</span> <span class="n">of</span> <span class="n">kernel</span>
        <span class="n">ext</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">write_stream_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">createStream</span><span class="p">(</span>
                <span class="n">device</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">XCL_STREAM_READ_ONLY</span><span class="p">,</span> <span class="n">CL_STREAM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
        <span class="n">ext</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="n">write_stream_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">createStream</span><span class="p">(</span>
                <span class="n">device</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">XCL_STREAM_READ_ONLY</span><span class="p">,</span> <span class="n">CL_STREAM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>

        <span class="o">//</span><span class="n">Create</span> <span class="n">read</span> <span class="n">stream</span> <span class="k">for</span> <span class="n">argument</span> <span class="mi">2</span> <span class="n">of</span> <span class="n">kernel</span>
        <span class="n">ext</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">read_stream</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">createStream</span><span class="p">(</span>
                <span class="n">device</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">XCL_STREAM_WRITE_ONLY</span><span class="p">,</span> <span class="n">CL_STREAM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="executing-the-kernel">
<h2>Executing the Kernel<a class="headerlink" href="#executing-the-kernel" title="Permalink to this headline">¶</a></h2>
<p>Now that you have set up the stream classes for the hardware, this step lets you send the data to the kernel on the device. As you work through this section, refer to step 2 in the host code.</p>
<ul class="simple">
<li><p>Set up the non-streaming kernel arguments</p></li>
<li><p>Execute the kernel.</p></li>
<li><p>Set up the offsets to divide the image for each CU.</p></li>
<li><p>Initiate and send the read and write stream transfer per CU.</p></li>
<li><p>Pool the streams.</p></li>
</ul>
<ol>
<li><p>Set the remaining non-streaming interface arguments and enqueue the kernel using the following standard APIs <code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">setargs</span></code> and <code class="docutils literal notranslate"><span class="pre">enqueueTask</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">lines_per_compute_unit</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">compute_units</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NCU</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">convolve_kernel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">coefficient_size</span><span class="p">);</span>
        <span class="n">convolve_kernel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">width</span><span class="p">);</span>
        <span class="n">convolve_kernel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">height</span><span class="p">);</span>
        <span class="n">convolve_kernel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">lines_per_compute_unit</span><span class="p">);</span>
        <span class="n">convolve_kernel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">lines_per_compute_unit</span><span class="p">);</span>
        <span class="n">q</span><span class="o">.</span><span class="n">enqueueTask</span><span class="p">(</span><span class="n">convolve_kernel</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="p">}</span>
    <span class="nb">int</span> <span class="n">img_width</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">width</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">img_height</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">height</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Before initiating the read and write transfers, you must partition the image with the correct offsets to access the image.</p>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">line_offset</span></code> and <code class="docutils literal notranslate"><span class="pre">offset</span></code> variables are used to calculate the offsets from the beginning of the image to the first pixel that the CU will read.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">padding</span></code> variable, on the other hand, is the number of pixels to read including the regions around the convolution window.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">num_lines</span></code> variable is the number of lines per CU.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">elements</span></code> is the total number of bytes to be computed per CU.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="p">(</span><span class="nb">int</span> <span class="n">cu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cu</span> <span class="o">&lt;</span> <span class="n">compute_units</span><span class="p">;</span> <span class="n">cu</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">int</span> <span class="n">line_offset</span> <span class="o">=</span> <span class="n">cu</span><span class="o">*</span><span class="n">lines_per_compute_unit</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">num_lines</span> <span class="o">=</span> <span class="n">lines_per_compute_unit</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">img_width</span> <span class="o">*</span> <span class="n">num_lines</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">std</span><span class="p">::</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">line_offset</span> <span class="o">-</span> <span class="n">half</span><span class="p">)</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">top_padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">bottom_padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">line_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">top_padding</span> <span class="o">=</span> <span class="n">half</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="n">img_width</span> <span class="o">*</span>  <span class="n">half</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">line_offset</span> <span class="o">+</span> <span class="n">num_lines</span> <span class="o">&lt;</span> <span class="n">img_height</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">padding</span> <span class="o">+=</span> <span class="n">img_width</span> <span class="o">*</span> <span class="n">half</span> <span class="o">+</span> <span class="n">COEFFICIENT_SIZE</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
        <span class="n">bottom_padding</span> <span class="o">=</span> <span class="n">img_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">half</span><span class="p">)</span> <span class="o">+</span> <span class="n">COEFFICIENT_SIZE</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Initiate the read and write stream transfer per CU using the <code class="docutils literal notranslate"><span class="pre">clReadStream</span></code> and <code class="docutils literal notranslate"><span class="pre">clWriteStream</span></code> commands. The read and write streams takes five arguments.</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">stream</span></code></strong>: The first argument takes the stream it needs to read/write to the device.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">ptr</span></code></strong>: The ptr argument contains the place for input/output argument.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">size</span></code></strong>: The number of bytes to write.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">req_type</span></code></strong>: The usage of attribute CL_STREAM_XFER_REQ associated with read and write request. The req_type should set the following arguments:</p>
<ul>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">flag</span></code></strong>: The flag is used to denote transfer mechanism:</p>
<ul>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">CL_STREAM_NONBLOCKING</span></code></strong>: By default, the Read and Write transfers are blocking. For non-blocking transfer, CL_STREAM_NONBLOCKING has to be set.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">.priv_data</span></code></strong>: The <code class="docutils literal notranslate"><span class="pre">.priv_data</span></code> is used to specify a string (as a name for tagging purposes) associated with the transfer. This will help identify specific transfer completion when polling the stream completion. It is required when using the non-blocking version of the API.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">errcode_ret</span></code></strong>: Return value (for example, CL_SUCCESS).</p></li>
</ul>
</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">vector_size_bytes</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">RGBPixel</span><span class="p">)</span><span class="o">*</span> <span class="p">(</span><span class="n">elements</span> <span class="o">+</span> <span class="n">padding</span><span class="p">);</span> 
       <span class="nb">int</span> <span class="n">coeff_size</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">*</span> <span class="n">COEFFICIENT_SIZE</span><span class="o">*</span><span class="n">COEFFICIENT_SIZE</span> <span class="p">;</span>
        <span class="n">cl_stream_xfer_req</span> <span class="n">rd_req</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
        <span class="n">cl_stream_xfer_req</span> <span class="n">wr_req</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>

        <span class="n">rd_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CL_STREAM_EOT</span> <span class="o">|</span><span class="n">CL_STREAM_NONBLOCKING</span><span class="p">;</span>
        <span class="n">wr_req</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CL_STREAM_EOT</span> <span class="o">|</span><span class="n">CL_STREAM_NONBLOCKING</span><span class="p">;</span>
        
        <span class="n">auto</span> <span class="n">write_tag_a</span> <span class="o">=</span> <span class="s2">&quot;write_a_&quot;</span> <span class="o">+</span> <span class="n">std</span><span class="p">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">cu</span><span class="p">);</span>
        <span class="n">wr_req</span><span class="o">.</span><span class="n">priv_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">write_tag_a</span><span class="o">.</span><span class="n">c_str</span><span class="p">();</span>
        <span class="n">RGBPixel</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">inFrame</span><span class="o">.</span><span class="n">data</span><span class="p">();</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
        <span class="n">std</span><span class="p">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Writing Stream write_stream_a[&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">cu</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;]&quot;</span><span class="p">;</span>
                  <span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">writeStream</span><span class="p">(</span><span class="n">write_stream_a</span><span class="p">[</span><span class="n">cu</span><span class="p">],</span>
                                           <span class="p">(</span><span class="n">p</span><span class="p">),</span>
                                           <span class="n">vector_size_bytes</span><span class="p">,</span>
                                           <span class="o">&amp;</span><span class="n">wr_req</span><span class="p">,</span>
                                           <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
        <span class="n">auto</span> <span class="n">write_tag_b</span> <span class="o">=</span> <span class="s2">&quot;write_b_&quot;</span> <span class="o">+</span> <span class="n">std</span><span class="p">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">cu</span><span class="p">);</span>
        <span class="n">wr_req</span><span class="o">.</span><span class="n">priv_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">write_tag_b</span><span class="o">.</span><span class="n">c_str</span><span class="p">();</span>
 <span class="n">std</span><span class="p">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Writing Stream write_stream_b[&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">cu</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;]&quot;</span><span class="p">;</span>
                   <span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">writeStream</span><span class="p">(</span><span class="n">write_stream_b</span><span class="p">[</span><span class="n">cu</span><span class="p">],</span>
                                            <span class="p">(</span><span class="n">filter_coeff</span><span class="o">.</span><span class="n">data</span><span class="p">()),</span>
                                           <span class="n">coeff_size</span><span class="p">,</span>
                                           <span class="o">&amp;</span><span class="n">wr_req</span><span class="p">,</span>
                                           <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
       <span class="n">auto</span> <span class="n">read_tag</span> <span class="o">=</span> <span class="s2">&quot;read_&quot;</span> <span class="o">+</span> <span class="n">std</span><span class="p">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">cu</span><span class="p">);</span>
        <span class="n">rd_req</span><span class="o">.</span><span class="n">priv_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">read_tag</span><span class="o">.</span><span class="n">c_str</span><span class="p">();</span>
        <span class="n">RGBPixel</span> <span class="o">*</span><span class="n">out_base</span> <span class="o">=</span> <span class="n">outFrame</span><span class="o">.</span><span class="n">data</span><span class="p">();</span>
       <span class="n">out_base</span> <span class="o">=</span> <span class="n">out_base</span> <span class="o">+</span> <span class="n">line_offset</span><span class="o">*</span><span class="n">img_width</span><span class="p">;</span>
       <span class="n">std</span><span class="p">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Reading Stream read_stream[&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">cu</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;]&quot;</span><span class="p">;</span>
                        <span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">readStream</span><span class="p">(</span><span class="n">read_stream</span><span class="p">[</span><span class="n">cu</span><span class="p">],</span>
                                          <span class="p">(</span><span class="n">outFrame</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">+</span><span class="n">line_offset</span><span class="o">*</span><span class="n">img_width</span><span class="p">),</span>
                                          <span class="p">(</span><span class="n">elements</span><span class="p">)</span><span class="o">*</span><span class="n">sizeof</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                                          <span class="o">&amp;</span><span class="n">rd_req</span><span class="p">,</span>
                                          <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
</pre></div>
</div>
<ol>
<li><p>Poll all the streams for completion.</p>
<ul class="simple">
<li><p>For the non-blocking transfer, a polling API is provided to ensure the read/write transfers are completed.</p></li>
<li><p>For the blocking version of the API, polling is not required. The polling results are stored in the cl_streams_poll_req_completions array, which can be used in verifying and checking the stream events result.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">clPollStreams</span></code> is a blocking API. It returns the execution to the host code as soon as it receives the notification that all stream requests have been completed, or until you specify the timeout.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">num_compl</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">NCU</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Checking</span> <span class="n">the</span> <span class="n">request</span> <span class="n">completions</span>
    <span class="n">cl_streams_poll_req_completions</span> <span class="o">*</span><span class="n">poll_req</span><span class="p">;</span>
    <span class="n">poll_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">cl_streams_poll_req_completions</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span>
        <span class="n">sizeof</span><span class="p">(</span><span class="n">cl_streams_poll_req_completions</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_compl</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">poll_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">cl_streams_poll_req_completions</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_compl</span><span class="p">);</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> clPollStreams for (</span><span class="si">%d</span><span class="s2">) events (CU: </span><span class="si">%d</span><span class="s2">, axis_in: 2, axis_out: 1)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">num_compl</span><span class="p">,</span>
        <span class="n">NCU</span><span class="p">);</span>
<span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">pollStreams</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                                    <span class="n">poll_req</span><span class="p">,</span>
                                    <span class="n">num_compl</span><span class="p">,</span>
                                    <span class="n">num_compl</span><span class="p">,</span>
                                    <span class="o">&amp;</span><span class="n">num_compl</span><span class="p">,</span>
                                    <span class="mi">50000</span><span class="p">,</span>
                                    <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="release-the-streams">
<h2>Release the Streams<a class="headerlink" href="#release-the-streams" title="Permalink to this headline">¶</a></h2>
<p>After the successful poll request is completed, the streams need to be released using the <code class="docutils literal notranslate"><span class="pre">releaseStream</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NCU</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">releaseStream</span><span class="p">(</span><span class="n">write_stream_a</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">releaseStream</span><span class="p">(</span><span class="n">write_stream_b</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">xcl</span><span class="p">::</span><span class="n">Stream</span><span class="p">::</span><span class="n">releaseStream</span><span class="p">(</span><span class="n">read_stream</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>This completes the required host code modifications.</p>
</div>
<div class="section" id="kernel-code-modifications">
<h2>Kernel Code Modifications<a class="headerlink" href="#kernel-code-modifications" title="Permalink to this headline">¶</a></h2>
<p>Next, modify the kernel code. The kernel code changes can be divided into four steps:</p>
<ul class="simple">
<li><p>Class used for host to kernel streaming.</p></li>
<li><p>Limitations of QDMA data type.</p></li>
<li><p>Change pointers to hls::stream.</p></li>
<li><p>Modify the data movers.</p></li>
</ul>
<div class="section" id="host-to-kernel-streaming">
<h3>Host to Kernel Streaming<a class="headerlink" href="#host-to-kernel-streaming" title="Permalink to this headline">¶</a></h3>
<p>Vitis HLS provides a C++ template class hls::stream&lt;&gt; for modeling streaming data structures. The streams implemented with the hls::stream&lt;&gt; class have the following attributes.</p>
<ul>
<li><p>Must use <code class="docutils literal notranslate"><span class="pre">qdma_axis&lt;D,0,0,0&gt;</span></code> data type. The <code class="docutils literal notranslate"><span class="pre">qdma_axis</span></code> data is available in the <code class="docutils literal notranslate"><span class="pre">ap_axi_sdata.h</span></code> header file.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">qdma_axis</span></code> data type contains three variables, which should be used inside the kernel code:</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">data</span></code></strong>: Internally, the qdma_axis data type contains an ap_int <D> that should be accessed by the .get_data() and .set_data() method. The D must be 8, 16, 32, 64, 128, 256, or 512 bits wide.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">last</span></code></strong>: The last variable is used to indicate the last value of an incoming and outgoing stream. When reading from the input stream, <code class="docutils literal notranslate"><span class="pre">last</span></code> is used to detect the end of the stream. Similarly, when the kernel writes to an output stream transferred to the host, the <code class="docutils literal notranslate"><span class="pre">last</span></code> variable must be set to indicate the end of stream.</p></li>
</ul>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">get_last/set_last</span></code></strong>: Accesses and sets the last variable used to denote the end of the stream.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">keep</span></code></strong>: In some special situations, the <code class="docutils literal notranslate"><span class="pre">keep</span></code> signal can be used to truncate the last data to the fewer number of bytes. However, the keep should not be used to any data other than the last data from the stream. Therefore, in most of the cases, you should set keep to -1 for all of the outgoing data from the kernel.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">get_keep/set_keep</span></code></strong>: Accesses/sets the <code class="docutils literal notranslate"><span class="pre">keep</span></code> variable. For all the data before the last data, <code class="docutils literal notranslate"><span class="pre">keep</span></code> must be set to -1 to denote all bytes of the data are valid. For the last data, the kernel has the flexibility to send fewer bytes. For example, for the four bytes of data transfer, the kernel can truncate the last data by sending one byte, two bytes, or three bytes using the following set_keep() function.</p>
<ul>
<li><p>If the last data is one byte ≥ <code class="docutils literal notranslate"><span class="pre">.set_keep(1)</span></code></p></li>
<li><p>If the last data is two bytes ≥ <code class="docutils literal notranslate"><span class="pre">.set_keep(3)</span></code></p></li>
<li><p>If the last data is three bytes ≥ <code class="docutils literal notranslate"><span class="pre">.set_keep(7)</span></code></p></li>
<li><p>If the last data is s all four bytes (similar to all non-last data) ≥ <code class="docutils literal notranslate"><span class="pre">set_keep(-1)</span></code>.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="qdma-data-type-limitations">
<h3>QDMA Data Type Limitations<a class="headerlink" href="#qdma-data-type-limitations" title="Permalink to this headline">¶</a></h3>
<p>Currently, the qdma class only supports <code class="docutils literal notranslate"><span class="pre">ap_uint</span></code> and cannot be overloaded. This design uses <code class="docutils literal notranslate"><span class="pre">floats</span></code> and <code class="docutils literal notranslate"><span class="pre">RGBPixel</span></code> as the data types. You will use a struct function to/from to separate and concatenate the <code class="docutils literal notranslate"><span class="pre">ap_int</span></code> into the <code class="docutils literal notranslate"><span class="pre">RGB</span></code> type.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#ifdef KERNEL_HEADERS</span>
<span class="c1">#include &quot;ap_axi_sdata.h&quot;</span>
<span class="c1">#include &quot;ap_int.h&quot;</span>
<span class="c1">#include &quot;hls_stream.h&quot;</span>
<span class="c1">#define DWIDTH 32</span>

<span class="n">typedef</span> <span class="n">qdma_axis</span><span class="o">&lt;</span><span class="n">DWIDTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="n">pkt</span><span class="p">;</span>
<span class="c1">#endif</span>


<span class="n">struct</span> <span class="n">RGBPixel</span>
<span class="p">{</span>
    <span class="n">unsigned</span> <span class="n">char</span> <span class="n">r</span><span class="p">;</span>
    <span class="n">unsigned</span> <span class="n">char</span> <span class="n">g</span><span class="p">;</span>
    <span class="n">unsigned</span> <span class="n">char</span> <span class="n">b</span><span class="p">;</span>
<span class="o">//</span>    <span class="n">unsigned</span> <span class="n">char</span> <span class="n">a</span><span class="p">;</span>
<span class="c1">#ifdef KERNEL_HEADERS</span>

<span class="n">void</span> <span class="n">init</span><span class="p">(</span><span class="n">ap_int</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span> <span class="n">d</span> <span class="p">)</span>
<span class="p">{</span>
<span class="c1">#pragma HLS INLINE</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>

<span class="p">}</span>
<span class="n">ap_int</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span> <span class="n">func1</span><span class="p">()</span>
<span class="p">{</span>
<span class="c1">#pragma HLS INLINE </span>
  <span class="n">ap_int</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">ap_int</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">,</span> <span class="n">ap_int</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span><span class="p">(</span><span class="n">g</span><span class="p">),</span> <span class="n">ap_int</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">;</span> 
<span class="p">}</span>

<span class="c1">#endif</span>

<span class="p">}</span><span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>
</pre></div>
</div>
<p>The same limitation is also applied to the <code class="docutils literal notranslate"><span class="pre">coeff</span></code> argument, so you will use a union to convert an <code class="docutils literal notranslate"><span class="pre">int</span></code> to a <code class="docutils literal notranslate"><span class="pre">float</span></code>. Place this in the <code class="docutils literal notranslate"><span class="pre">convolve_fpga.cpp</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">union</span> <span class="n">test</span><span class="p">{</span>
<span class="nb">int</span> <span class="n">x</span><span class="p">;</span>
<span class="nb">float</span> <span class="n">y</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="modify-the-kernel-interface">
<h3>Modify the Kernel Interface<a class="headerlink" href="#modify-the-kernel-interface" title="Permalink to this headline">¶</a></h3>
<p>Change the following kernel interface from memory mapped to <code class="docutils literal notranslate"><span class="pre">hls::stream</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">convolve_fpga</span><span class="p">(</span> <span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">pkt</span><span class="o">&gt;&amp;</span> <span class="n">inFrame</span><span class="p">,</span> <span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">pkt</span><span class="o">&gt;&amp;</span> <span class="n">outFrame</span><span class="p">,</span>
		<span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">pkt</span><span class="o">&gt;&amp;</span> <span class="n">coefficient</span><span class="p">,</span>
		<span class="nb">int</span> <span class="n">coefficient_size</span><span class="p">,</span> <span class="nb">int</span> <span class="n">img_width</span><span class="p">,</span> <span class="nb">int</span> <span class="n">img_heightint</span> <span class="n">line_offset</span><span class="p">,</span> <span class="nb">int</span> <span class="n">num_lines</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="section" id="modify-the-data-movers">
<h3>Modify the Data Movers<a class="headerlink" href="#modify-the-data-movers" title="Permalink to this headline">¶</a></h3>
<p>In the previous step, the kernel code is divided into three steps: read, compute, and write functions. The read/write function are the data movers from/to the DDR. This step only needs to change these data movers which originally use array pointers to <code class="docutils literal notranslate"><span class="pre">hls::stream</span></code> objects. This <code class="docutils literal notranslate"><span class="pre">hls::stream</span></code> uses the <code class="docutils literal notranslate"><span class="pre">ap_axiu</span></code> objects as mentioned above. This function uses the methods mentioned above to read the data until the last packet is received using the <code class="docutils literal notranslate"><span class="pre">do-while</span></code> loop.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">void</span> <span class="n">read_dataflow</span><span class="p">(</span><span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">RGBPixel</span><span class="o">&gt;&amp;</span> <span class="n">read_stream</span><span class="p">,</span> <span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">pkt</span><span class="o">&gt;&amp;</span> <span class="ow">in</span><span class="p">,</span>
                   <span class="nb">int</span> <span class="n">img_width</span><span class="p">,</span> <span class="nb">int</span> <span class="n">elements</span><span class="p">,</span> <span class="nb">int</span> <span class="n">half</span><span class="p">,</span>
                   <span class="nb">int</span> <span class="n">top_padding</span><span class="p">,</span> <span class="nb">int</span> <span class="n">bottom_padding</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">while</span><span class="p">(</span><span class="n">top_padding</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">read_stream</span> <span class="o">&lt;&lt;</span> <span class="n">zero</span><span class="p">;</span>
     <span class="p">}</span>
    <span class="n">RGBPixel</span> <span class="n">a_temp</span><span class="p">;</span>
     <span class="nb">int</span> <span class="n">pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="n">ap_int</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">last</span><span class="p">;</span>
     <span class="nb">bool</span> <span class="n">eos</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
     <span class="n">do</span><span class="p">{</span>

    <span class="n">pkt</span> <span class="n">a_t</span> <span class="o">=</span> <span class="ow">in</span><span class="o">.</span><span class="n">read</span><span class="p">();</span>
    <span class="n">ap_int</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span> <span class="n">in1</span> <span class="o">=</span> <span class="n">a_t</span><span class="o">.</span><span class="n">get_data</span><span class="p">();</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">a_t</span><span class="o">.</span><span class="n">get_last</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">eos</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
    <span class="p">}</span>
      <span class="n">a_temp</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">in1</span><span class="p">);</span>
       <span class="n">RGBPixel</span> <span class="n">a</span><span class="p">;</span>
       <span class="n">a</span> <span class="o">=</span> <span class="n">a_temp</span><span class="p">;</span>
         <span class="n">read_stream</span> <span class="o">&lt;&lt;</span> <span class="n">a_temp</span><span class="p">;</span>

     <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="n">eos</span> <span class="o">==</span><span class="n">false</span><span class="p">);</span>

        <span class="k">while</span><span class="p">(</span><span class="n">bottom_padding</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">read_stream</span> <span class="o">&lt;&lt;</span> <span class="n">zero</span><span class="p">;</span>
     <span class="p">}</span>
 <span class="p">}</span>


 <span class="n">void</span> <span class="n">write_dataflow</span><span class="p">(</span><span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">pkt</span><span class="o">&gt;&amp;</span> <span class="n">outFrame</span><span class="p">,</span> <span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">RGBPixel</span><span class="o">&gt;&amp;</span> <span class="n">write_stream</span><span class="p">,</span>
                     <span class="nb">int</span> <span class="n">elements</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="nb">int</span> <span class="n">pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="n">pkt</span> <span class="n">t_out</span><span class="p">;</span>
     <span class="n">ap_int</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span> <span class="n">a_out</span><span class="p">;</span>
     <span class="n">RGBPixel</span> <span class="n">tmpout</span><span class="p">;</span>
     <span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
     <span class="k">while</span><span class="p">(</span><span class="n">elements</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">write_stream</span> <span class="o">&gt;&gt;</span> <span class="n">tmpout</span><span class="p">;</span>
        <span class="n">a_out</span> <span class="o">=</span> <span class="n">tmpout</span><span class="o">.</span><span class="n">func1</span><span class="p">();</span>
       <span class="n">t_out</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">a_out</span><span class="p">);</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">elements</span> <span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">t_out</span><span class="o">.</span><span class="n">set_last</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">t_out</span><span class="o">.</span><span class="n">set_last</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
           <span class="n">t_out</span><span class="o">.</span><span class="n">set_keep</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
             <span class="n">outFrame</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">t_out</span><span class="p">);</span>
        <span class="p">}</span>
     <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="run-hardware-emulation-for-multiple-cus-with-streaming-interfaces">
<h2>Run Hardware Emulation for Multiple CUs with Streaming Interfaces<a class="headerlink" href="#run-hardware-emulation-for-multiple-cus-with-streaming-interfaces" title="Permalink to this headline">¶</a></h2>
<ol>
<li><p>Before running emulation, you need to set the number of CUs to 4. Open the <code class="docutils literal notranslate"><span class="pre">design.cfg</span></code> and modify the <code class="docutils literal notranslate"><span class="pre">nk</span></code> option as follows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nk</span><span class="o">=</span><span class="n">convolve_fpga</span><span class="p">:</span><span class="mi">4</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">nk</span></code> option is used to specify the number of kernel instances, or CUs, generated during the linking step of the build process.</p>
</li>
<li><p>Go to the <code class="docutils literal notranslate"><span class="pre">makefile</span></code> directory.</p></li>
<li><p>Use the following command to run hardware emulation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">run</span> <span class="n">TARGET</span><span class="o">=</span><span class="n">hw_emu</span> <span class="n">STEP</span><span class="o">=</span><span class="n">qdma</span> <span class="n">SOLUTION</span><span class="o">=</span><span class="mi">1</span> <span class="n">NUM_FRAMES</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>The following code shows the results of this kernel running on four CUs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Data</span> <span class="n">transfer</span> <span class="n">on</span> <span class="n">stream</span> <span class="n">interfaces</span>
<span class="n">HOST</span><span class="o">--&gt;</span><span class="n">convolve_fpga_1</span><span class="p">:</span><span class="n">coefficient</span>           <span class="mf">0.035</span> <span class="n">KB</span>        
<span class="n">HOST</span><span class="o">--&gt;</span><span class="n">convolve_fpga_3</span><span class="p">:</span><span class="n">inFrame</span>               <span class="mf">24.012</span> <span class="n">KB</span>       
<span class="n">convolve_fpga_3</span><span class="p">:</span><span class="n">outFrame</span><span class="o">--&gt;</span><span class="n">HOST</span>              <span class="mf">20.000</span> <span class="n">KB</span>       
<span class="n">HOST</span><span class="o">--&gt;</span><span class="n">convolve_fpga_4</span><span class="p">:</span><span class="n">coefficient</span>           <span class="mf">0.035</span> <span class="n">KB</span>        
<span class="n">HOST</span><span class="o">--&gt;</span><span class="n">convolve_fpga_4</span><span class="p">:</span><span class="n">inFrame</span>               <span class="mf">22.000</span> <span class="n">KB</span>       
<span class="n">convolve_fpga_4</span><span class="p">:</span><span class="n">outFrame</span><span class="o">--&gt;</span><span class="n">HOST</span>              <span class="mf">20.000</span> <span class="n">KB</span>       
<span class="n">HOST</span><span class="o">--&gt;</span><span class="n">convolve_fpga_1</span><span class="p">:</span><span class="n">inFrame</span>               <span class="mf">22.012</span> <span class="n">KB</span>       
<span class="n">convolve_fpga_1</span><span class="p">:</span><span class="n">outFrame</span><span class="o">--&gt;</span><span class="n">HOST</span>              <span class="mf">20.000</span> <span class="n">KB</span>       
<span class="n">HOST</span><span class="o">--&gt;</span><span class="n">convolve_fpga_2</span><span class="p">:</span><span class="n">coefficient</span>           <span class="mf">0.035</span> <span class="n">KB</span>        
<span class="n">HOST</span><span class="o">--&gt;</span><span class="n">convolve_fpga_2</span><span class="p">:</span><span class="n">inFrame</span>               <span class="mf">24.012</span> <span class="n">KB</span>       
<span class="n">convolve_fpga_2</span><span class="p">:</span><span class="n">outFrame</span><span class="o">--&gt;</span><span class="n">HOST</span>              <span class="mf">20.000</span> <span class="n">KB</span>       
<span class="n">HOST</span><span class="o">--&gt;</span><span class="n">convolve_fpga_3</span><span class="p">:</span><span class="n">coefficient</span>            <span class="mf">0.035</span> <span class="n">KB</span>        
</pre></div>
</div>
<p>You can now perform four times more work in about the same amount of time. Because each CU needs to read the surrounding padded lines, more data is transferred from the global memory.</p>
</li>
</ol>
</div>
<div class="section" id="view-profile-summary-report-for-hardware-emulation">
<h2>View Profile Summary Report for Hardware Emulation<a class="headerlink" href="#view-profile-summary-report-for-hardware-emulation" title="Permalink to this headline">¶</a></h2>
<p>Use the following command to view the Profile Summary report.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">view_run_summary</span> <span class="n">TARGET</span><span class="o">=</span><span class="n">hw_emu</span> <span class="n">STEP</span><span class="o">=</span><span class="n">qdma</span>
</pre></div>
</div>
<p>The kernel execution time for the four CUs is around 0.135061 ms each.</p>
<p>Here is the updated table.</p>
<p>| Step                    | Image Size | Time (HW-EM)(ms) | Reads (KB)      | Writes (KB)    | Avg. Read (KB) | Avg. Write (KB) | Bandwidth (MBps)  |
| :——————-    | :——— | —————: | ————–: | ————-: | ————-: | ————–: | ———: |
| baseline                |     512x10 | 3.903            | 344             |        20.0    |          0.004 |           0.004 |    5.2     |
| localbuf                |     512x10 | 1.574 (2.48x)    | 21 (0.12x)      |        20.0    |          0.064 |           0.064 |    13      |
| fixed-type data         |     512x10 | 0.46 (3.4x)      | 21              |        20.0    |          0.064 |           0.064 |    44      |
| dataflow                |     512x10 | 0.059 (7.8x)     | 21              |        20.0    |          0.064 |           0.064 |    347     |
| multi-CU                |     512x40*| 0.358           | 92        |       80.0 (4x)|          0.064 |           0.064 |    1365*   |
| Stream-multi-CU	  |     512x40*| 0.130561  (~3x)  | 96.188 (4.3x)       |       80.0 |          22.540 |           0.036 |    1200   |</p>
<blockquote>
<div><p><strong>NOTE:</strong></p>
<ul class="simple">
<li><p>The Stream-multi-CU version processed four times of the data compared to the previous versions. Even if the execution time for each CU does not change, four parallel CUs increase the system performance by almost four times.</p></li>
<li><p>This is calculated by 4x data/time. Here the data transfer time is not accounted for, and you assume that the four CUs are executing in parallel. This is not as accurate as the hardware run, but you will use it as a reference for optimizations effectiveness.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<p>In this step, you performed the host code and kernel code modifications to generate multiple streaming  CUs. In the next step, you have the application <a class="reference internal" href="RunOnHardware.html"><span class="doc">run the accelerator in hardware</span></a>.</p>
<p></br></p>
<hr/>
<p align="center" class="sphinxhide"><b><a href="/docs/vitis-getting-started/README.md">Return to Getting Started Pathway</a> — <a href="/docs/convolution-tutorial/README.md">Return to Start of Tutorial</a></b></p><p align="center" class="sphinxhide"><sup>Copyright&copy; 2020 Xilinx</sup></p></div>
</div>


           </div>
           
          </div>
          <footer>
<!-- Atalwar: Moved the footer code to layout.html to resolve conflict with the Xilinx template -->
</footer>

        </div>
      </div>
	  
	  
	  <!-- Sphinx Page Footer block -->
  

  <hr/>

  <div role="contentinfo" class="copyright">
    <p class="footerinfo">
      <span class="lastupdated">
        Last updated on July 23, 2020.
      </span>

    </p>
  </div>	  
      </div>
    </section>


  




  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

   <script type="text/javascript">
    jQuery(function() { Search.loadIndex("searchindex.js"); });
  </script>

  <script type="text/javascript" id="searchindexloader"></script>     	    
	    
	    
  
  
    
  
  

  
  <!--  Xilinx template footer block -->
							</div>
						</div>
					</div>
				</div>
				<div class="xilinxExperienceFragments experiencefragment aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
					<div class="xf-content-height">
						<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
							<div class="footer parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
								<noindex>
									<footer>
										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">
													<div class="row">
														<div class="footerSocial parbase">
															<div class="col-md-push-6 col-lg-push-6 col-md-6 col-lg-6">
																<ul class="list-inline pull-right social-menu">
																	<li>
																		<a href="https://www.linkedin.com/company/xilinx">
																		<span class="linkedin icon"></span>
																		<span class="sr-only">Connect on LinkedIn</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.twitter.com/XilinxInc">
																		<span class="twitter icon"></span>
																		<span class="sr-only">Follow us on Twitter</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.facebook.com/XilinxInc">
																		<span class="facebook icon"></span>
																		<span class="sr-only">Connect on Facebook</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.youtube.com/XilinxInc">
																		<span class="youtube icon"></span>
																		<span class="sr-only">Watch us on YouTube</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.xilinx.com/registration/subscriber-signup.html">
																		<span class="newsletter icon"></span>
																		<span class="sr-only">Subscribe to Newsletter</span>
																		</a>
																	</li>
																</ul>
															</div>
														</div>
														<div class="col-md-pull-6 col-lg-pull-6 col-md-6 col-lg-6">
															<span class="copyright">
                                  
                                  &copy; 2020, Xilinx
                              </span>
															<ul class="list-inline sub-menu">
																<li>
																	<a href="https://www.xilinx.com/about/privacy-policy.html">Privacy</a>
																</li>
																<li>
																	<a href="https://www.xilinx.com/about/legal.html">Legal</a>
																</li>
																<li>
																	<a href="https://www.xilinx.com/about/contact.html">Contact</a>
																</li>
															</ul>
														</div>
													</div>
												</div>
											</div>
										</div>
									</footer>
								</noindex>
							</div>
						</div>
					</div>
				</div>
				<div class="quicklinks parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
					<noindex>
						<span class="quickLinks">
							<ul>
								<li>
									<a href="#top" class="btn backToTop">
									<span class="fas fa-angle-up" aria-hidden="true"></span>
									</a>
								</li>
							</ul>
						</span>
					</noindex>
				</div>
			</div>
		</div>
		<script>window.CQ = window.CQ || {}</script>
		<script src="https://static.cloud.coveo.com/searchui/v2.4382/js/CoveoJsSearch.Lazy.min.js"></script>
		<script>
			var underscoreSetup = function () {
			  _.templateSettings.interpolate = /\{\{=([^-][\S\s]+?)\}\}/g;
			  _.templateSettings.evaluate = /\{\{([^-=][\S\s]+?)\}\}/g;
			  _.templateSettings.escape = /\{\{-([^=][\S\s]+?)\}\}/g;
			}
			
			underscoreSetup();
		</script>
	</body>
</html>