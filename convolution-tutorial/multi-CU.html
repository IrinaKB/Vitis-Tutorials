


<!DOCTYPE HTML>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
	<head>
		<meta charset="utf-8">
		
		<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
		<link rel="stylesheet" href="https://static.cloud.coveo.com/searchui/v2.4382/css/CoveoFullSearch.css"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<meta name="description"/>
		<meta name="keywords"/>
		<meta property="og:title" content=""/>
		<meta property="og:description"/>
		<!-- favicon -->
		<link rel="icon" type="image/vnd.microsoft.icon" href="../_static/favicon.ico"/>
		<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../_static/favicon.ico"/>
		<!-- Fonts -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet" type="text/css"/>

  
  
  
  

  
      <script type="text/javascript" src="../_static/js/jquery.min.js"></script>	
	  <script type="text/javascript" src="../_static/js/gtm.js"></script>
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
    <script type="text/javascript" src="../_static/js/d3dd8c60ed.js"></script>
    <script type="text/javascript" src="../_static/js/common-ui-all.min.js"></script>		
    <script type="text/javascript" src="../_static/js/header-footer.min.js"></script>	
    <script type="text/javascript" src="../_static/js/jquery-ui.min.js"></script>	
    <script type="text/javascript" src="../_static/js/CoveoJsSearch.Lazy.min.js"></script>	
    <script type="text/javascript" src="../_static/js/linkid.js"></script>		
    <script type="text/javascript" src="../_static/js/Searchbox.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/common-ui-all.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/header-footer.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/pro.min.css" media="all" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
	</head>
	<body>
		<div class="xilinx-bs3"/>
		<div class="root responsivegrid">
			<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 aem-Grid--large--16 aem-Grid--xlarge--16 aem-Grid--xxlarge--16 aem-Grid--xxxlarge--16 ">
				<div class="xilinxExperienceFragments experiencefragment aem-GridColumn aem-GridColumn--default--12">
					<div class="xf-content-height">
						<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
							<div class="header parbase aem-GridColumn aem-GridColumn--default--12">
								<noindex>
									<header data-component="header">
										<nav class="navbar navbar-default aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid main-nav">
													<div class="row">
														<div class="col-xs-12">
															<div class="logo-column">
																<div class="logo">
																	<a href="https://www.xilinx.com/">
																	<img src="https://www.xilinx.com/etc.clientlibs/site/clientlibs/xilinx/all/resources/imgs/header/xilinx-header-logo.svg" title="Xilinx Inc"/>
																	</a>
																</div>
															</div>
															<div class="navbar-column">
																<div class="navbar navbar-collapse collapse" id="xilinx-main-menu">
																	<div class="mobile-search-container">
																		<div id="headerSearchBox" class="headerSearch"
																			data-component="header-search" 
																			data-redirect-if-empty="false"
																			data-coveo-access-token="xxa237d4dd-f0aa-47fc-9baa-af9121851b33"
																			data-coveo-organization-id="xilinxcomprode2rjoqok">
																			<div class='coveo-search-section'>
																				<div class="CoveoAnalytics" data-search-hub="Site"></div>
																				<ul class="dropdown-menu options">
																					<li class="option" data-label="All" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-search-hub="Site">
																						<a href="#">
																						All</a>
																					</li>
																					<li data-label="Silicon Devices" data-action-link="https://www.xilinx.com//products/silicon-devices/si-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Silicon Devices</a>
																					</li>
																					<li data-label="Boards and Kits" data-action-link="https://www.xilinx.com//products/boards-and-kits/bk-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Boards and Kits</a>
																					</li>
																					<li data-label="Intellectual Property" data-action-link="https://www.xilinx.com//products/intellectual-property/ip-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Intellectual Property</a>
																					</li>
																					<li data-label="Support" class="option" data-action-link="https://www.xilinx.com/search/support-keyword-search.html" data-search-hub="Support">
																						<a href="#">
																						Support</a>
																						<ul>
																							<li data-label="Documentation" data-action-link="https://www.xilinx.com//support/documentation-navigation/documentation-keyword-search.html" data-search-hub="Document">
																								<a href="#">
																								Documentation</a>
																							</li>
																							<li data-label="Knowledge Base" data-action-link="https://www.xilinx.com//support/answer-navigation/answer-keyword-search.html" data-search-hub="AnswerRecord">
																								<a href="#">
																								Knowledge Base</a>
																							</li>
																							<li data-label="Community Forums" data-action-link="https://www.xilinx.com/search/forums-keyword-search.html" data-search-hub="Forums">
																								<a href="#">
																								Community Forums</a>
																							</li>
																						</ul>
																					</li>
																					<li data-label="Partners" data-action-link="https://www.xilinx.com//alliance/member-keyword-search.html" data-search-hub="Partner">
																						<a href="#">
																						Partners</a>
																					</li>
																					<li data-label="Videos" data-action-link="https://www.xilinx.com/video/video-keyword-search.html" data-search-hub="Video">
																						<a href="#">
																						Videos</a>
																					</li>
																					<li data-label="Press" data-action-link="https://www.xilinx.com/search/press-keyword-search.html" data-search-hub="Press">
																						<a href="#">
																						Press</a>
																					</li>
																				</ul>
																				<a href="#" class="btn dropdown-toggle value" data-toggle="dropdown"></a>
																				<div class="CoveoSearchbox" data-id="coveosearchbox" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-placeholder="Search Xilinx"></div>
																			</div>
																		</div>
																	</div>
																	<ul class="nav navbar-nav nav-justified">
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/applications.html">
																			Applications</a> 
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/products/silicon-devices.html">
																			Products</a> 
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://developer.xilinx.com/">
																			Developers</a> 
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/support.html">
																			Support</a> 
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/about/company-overview.html">
																			About</a> 
																		</li>
																	</ul>
																</div>
															</div>
															<script type="text/javascript" src="../_static/js/gtm.js"></script>
															<!--<div class="mini-nav">
																<button type="button" data-function="xilinx-mobile-menu" id="nav-toggle" class="navbar-toggle collapsed visible-xs-block" aria-expanded="false">
																<span></span>
																<span></span>
																<span></span>
																<span></span>
																</button>
																<ul class="list-inline">
																	<li class="dropdown user-menu">
																		<button data-toggle="dropdown">
																		<span class="sr-only">Account</span>
																		<span class="fas fa-user"></span>
																		</button>
																		<ul class="dropdown-menu">
																			<li>
																				<a href="https://www.xilinx.com/myprofile/subscriptions.html">
																				My Account</a>
																			</li>
																			<li>
																				<a href="https://www.xilinx.com/registration/create-account.html">
																				Create Account</a>
																			</li>
																			<li>
																				<a href="https://www.xilinx.com/bin/protected/en/signout">
																				Sign Out</a>
																			</li>
																		</ul>
																	</li>
																	<li class="hidden-xs">
																		<button data-function="search-toggle">
																		<span class="sr-only">Search</span>
																		<span class="far fa-search"></span>
																		</button>
																	</li>
																</ul>
															</div>
															-->
															<div class="search-container">
																<div id="headerSearchBox" class="headerSearch"
																	data-component="header-search" 
																	data-redirect-if-empty="false"
																	data-coveo-access-token="xxa237d4dd-f0aa-47fc-9baa-af9121851b33"
																	data-coveo-organization-id="xilinxcomprode2rjoqok">
																	<div class='coveo-search-section'>
																		<div class="CoveoAnalytics" data-search-hub="Site"></div>
																		<ul class="dropdown-menu options">
																			<li class="option" data-label="All" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-search-hub="Site">
																				<a href="#">
																				All</a>
																			</li>
																			<li data-label="Silicon Devices" data-action-link="https://www.xilinx.com/products/silicon-devices/si-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Silicon Devices</a>
																			</li>
																			<li data-label="Boards and Kits" data-action-link="https://www.xilinx.com/products/boards-and-kits/bk-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Boards and Kits</a>
																			</li>
																			<li data-label="Intellectual Property" data-action-link="https://www.xilinx.com/products/intellectual-property/ip-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Intellectual Property</a>
																			</li>
																			<li data-label="Support" class="option" data-action-link="https://www.xilinx.com/search/support-keyword-search.html" data-search-hub="Support">
																				<a href="#">
																				Support</a>
																				<ul>
																					<li data-label="Documentation" data-action-link="https://www.xilinx.com/support/documentation-navigation/documentation-keyword-search.html" data-search-hub="Document">
																						<a href="#">
																						Documentation</a>
																					</li>
																					<li data-label="Knowledge Base" data-action-link="https://www.xilinx.com/support/answer-navigation/answer-keyword-search.html" data-search-hub="AnswerRecord">
																						<a href="#">
																						Knowledge Base</a>
																					</li>
																					<li data-label="Community Forums" data-action-link="https://www.xilinx.com/search/forums-keyword-search.html" data-search-hub="Forums">
																						<a href="#">
																						Community Forums</a>
																					</li>
																				</ul>
																			</li>
																			<li data-label="Partners" data-action-link="https://www.xilinx.com/alliance/member-keyword-search.html" data-search-hub="Partner">
																				<a href="#">
																				Partners</a>
																			</li>
																			<li data-label="Videos" data-action-link="https://www.xilinx.com/video/video-keyword-search.html" data-search-hub="Video">
																				<a href="#">
																				Videos</a>
																			</li>
																			<li data-label="Press" data-action-link="https://www.xilinx.com/search/press-keyword-search.html" data-search-hub="Press">
																				<a href="#">
																				Press</a>
																			</li>
																		</ul>
																		<a href="#" class="btn dropdown-toggle value" data-toggle="dropdown"></a>
																		<div class="CoveoSearchbox" data-id="coveosearchbox" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-placeholder="Search Xilinx"></div>
																	</div>
																</div>
																<button data-function="search-toggle">
																<span class="sr-only">Search</span>
																<span class="far fa-times"></span>
																</button>
															</div>
														</div>
													</div>
												</div>
											</div>
										</nav>
									</header>
								</noindex>
							</div>
						</div>
					</div>
				</div>
				<div class="parsys aem-GridColumn--xxxlarge--none aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
						<div class="container-fluid">
							<div class="row">
							<div class="col-xs-12">
   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../README.html" class="icon icon-home" alt="Documentation Home"> Vitis™ Application Acceleration Development Flow Tutorials
          

          
          </a>

          
            
            
              <div class="version">
                2020.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started Pathway</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vitis-getting-started/README.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vitis-execution-model/README.html">Execution Model of an FPGA Accelerated Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../alveo-getting-started/README.html">Getting Started with the Alveo Portfolio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Pathway3/README.html">Essential Concepts for Building and Running the Accelerated Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../my-first-program/README.html">My First Program</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html">Optimizing Accelerated FPGA Applications: Convolution Example</a></li>
</ul>
<p class="caption"><span class="caption-text">Intermediate</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started-rtl-kernels/README.html">Getting Started with RTL Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vitis_hls_analysis/README.html">Vitis HLS Analysis and Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mixing-c-rtl-kernels/README.html">Mixing C++ and RTL Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using-multiple-cu/README.html">Using Multiple Compute Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../host-code-opt/README.html">Host Code Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mult-ddr-banks/README.html">Using Multiple DDR Banks</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../controlling-vivado-impl/README.html">Controlling Vivado Implementation</a></li>
</ul>
<p class="caption"><span class="caption-text">Versions</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/2020-1/docs/README.html">Master</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Xilinx/Vitis-Tutorials/blob/master/README.md">2019.2</a></li>
</ul>

            
			
			<p class="caption"><span class="caption-text">This Page</span></p>
				<ul class="current">
				  <li class="toctree-l1"><a href="../_sources/convolution-tutorial/multi-CU.md.txt"
						rel="nofollow">Show Source</a></li>						
				</ul>
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../README.html">Vitis™ Application Acceleration Development Flow Tutorials</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../README.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>6. Using Out-of-Order Queues and Multiple Compute Units</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/convolution-tutorial/multi-CU.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <table class="sphinxhide">
 <tr>
   <td align="center"><img src="https://www.xilinx.com/content/dam/xilinx/imgs/press/media-kits/corporate/xilinx-logo.png" width="30%"/><h1>2020.1 Vitis™ Application Acceleration Development Flow Tutorials</h1>
   <a href="https://github.com/Xilinx/Vitis-Tutorials/branches/all">See 2019.2 Vitis Application Acceleration Development Flow Tutorials</a>
   </td>
 </tr>
 <tr>
 <td>
 </td>
 </tr>
</table><div class="section" id="using-out-of-order-queues-and-multiple-compute-units">
<h1>6. Using Out-of-Order Queues and Multiple Compute Units<a class="headerlink" href="#using-out-of-order-queues-and-multiple-compute-units" title="Permalink to this headline">¶</a></h1>
<p>In the previous labs, you concentrated on extracting parallelism within a kernel using techniques such as pipelining and dataflow. One of the very powerful features of FPGAs is that you can create multiple compute units (CUs), which are identical copies of your kernel, allowing more processing to happen in parallel. These CUs can be used to process multiple images at the same time, or divide one image into smaller regions, so that you can process each frame faster. In this tutorial, you are going to take the latter approach to speed up computation of each individual frame.</p>
<p>To take advantage of acceleration potential offered by the multiple CUs, the host application needs to be able to issue and manage multiple concurrent requests to the CUs. For maximum performance, it is important to ensure that the application keeps all the CUs busy. Any delay in transferring data or starting a CU will reduce the overall performance.</p>
<p>In this lab, you will first implement changes in the host code to handle multiple CUs, then make updates to the kernel to handle subregions of a frame.</p>
<div class="section" id="executing-queued-operations-out-of-order">
<h2>Executing Queued Operations Out-of-Order<a class="headerlink" href="#executing-queued-operations-out-of-order" title="Permalink to this headline">¶</a></h2>
<p>The host application uses OpenCL™ APIs to communicate with kernels on an FPGA. Those commands are executed through a command queue object. By default, the command queue is handled in order; however, you can change this behavior to execute your operations in any order by passing a special flag to the command queue. This type of queue will execute whatever operation is ready to execute as soon as the resources are available.</p>
<p>Out-of-order queues allow you to launch multiple operations at the same time, including memory transfers and kernel calls. You can add dependencies on tasks using OpenCL API events and wait lists. Events are objects that are associated with a particular task. It is usually passed into a call as the last argument. If an operation depends on another task, you can pass the event into a wait list. The operation will need to wait for all events in the wait list to finish before executing.</p>
<blockquote>
<div><p><strong>TIP:</strong> The completed host code source file is provided under the <code class="docutils literal notranslate"><span class="pre">reference-files/multicu</span></code> folder. You can use it as a reference if needed.</p>
</div></blockquote>
<p>To take advantage of the out-of-order queues and events, modify the host program.</p>
<ol>
<li><p>Open the <code class="docutils literal notranslate"><span class="pre">convolve.cpp</span></code> file from <code class="docutils literal notranslate"><span class="pre">src/multicu</span></code> and modify the following line.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">cl</span><span class="p">::</span><span class="n">CommandQueue</span> <span class="n">q</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">cl</span><span class="p">::</span><span class="n">QueueProperties</span><span class="p">::</span><span class="n">Profiling</span><span class="p">);</span>
</pre></div>
</div>
<p>to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">cl</span><span class="p">::</span><span class="n">CommandQueue</span> <span class="n">q</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">cl</span><span class="p">::</span><span class="n">QueueProperties</span><span class="p">::</span><span class="n">Profiling</span> <span class="o">|</span> <span class="n">cl</span><span class="p">::</span><span class="n">QueueProperties</span><span class="p">::</span><span class="n">OutOfOrder</span><span class="p">);</span>
</pre></div>
</div>
<p>Passing <code class="docutils literal notranslate"><span class="pre">cl::QueueProperties::OutOfOrder</span></code> enum to the <code class="docutils literal notranslate"><span class="pre">CommandQueue</span></code> constructor tells the runtime that the operations on this queue can be executed out-of-order.</p>
</li>
<li><p>With an out-of-order queue, you must now enforce ordering between the read, enqueueTask, and write calls to make sure that you do not read the buffer before the copy operation has completed. You will create a <code class="docutils literal notranslate"><span class="pre">cl::Event</span></code> object and pass it as the last argument of the <code class="docutils literal notranslate"><span class="pre">enqueueWriteBuffer</span></code> function. Change line 95 from:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">q</span><span class="o">.</span><span class="n">enqueueWriteBuffer</span><span class="p">(</span><span class="n">buffer_input</span><span class="p">,</span> <span class="n">CL_FALSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frame_bytes</span><span class="p">,</span> <span class="n">inFrame</span><span class="o">.</span><span class="n">data</span><span class="p">());</span>
</pre></div>
</div>
<p>to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">cl</span><span class="p">::</span><span class="n">Event</span> <span class="n">write_event</span><span class="p">;</span>
 <span class="n">q</span><span class="o">.</span><span class="n">enqueueWriteBuffer</span><span class="p">(</span><span class="n">buffer_input</span><span class="p">,</span> <span class="n">CL_FALSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frame_bytes</span><span class="p">,</span> <span class="n">inFrame</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">write_event</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">write_event</span></code> object will be used to enforce this operation’s dependency on the next task.</p>
</li>
<li><p>You need to pass the <code class="docutils literal notranslate"><span class="pre">write_event</span></code> to the <code class="docutils literal notranslate"><span class="pre">enqueueTask</span></code> call. You must also create an event object for the task to pass to the read operation. The <code class="docutils literal notranslate"><span class="pre">write_event</span></code> object from the previous call must be passed into this call through a pointer to a vector. Modify the <code class="docutils literal notranslate"><span class="pre">enqueueTask</span></code> call in line 96 as follows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">cl</span><span class="p">::</span><span class="n">Event</span><span class="o">&gt;</span> <span class="n">iteration_events</span><span class="p">{</span><span class="n">write_event</span><span class="p">};</span>
 <span class="n">cl</span><span class="p">::</span><span class="n">Event</span> <span class="n">task_event</span><span class="p">;</span>
 <span class="n">q</span><span class="o">.</span><span class="n">enqueueTask</span><span class="p">(</span><span class="n">convolve_kernel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iteration_events</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">task_event</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>The read call needs to be executed after the <code class="docutils literal notranslate"><span class="pre">convolve_kernel</span></code> has finished executing. Just like in the previous operations, you can also send the event as the last argument of this function. Modify the <code class="docutils literal notranslate"><span class="pre">enqueueReadBuffer</span></code> call in line 97 as follows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">iteration_events</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">task_event</span><span class="p">);</span>
 <span class="n">cl</span><span class="p">::</span><span class="n">Event</span> <span class="n">read_event</span><span class="p">;</span>
 <span class="n">q</span><span class="o">.</span><span class="n">enqueueReadBuffer</span><span class="p">(</span><span class="n">buffer_output</span><span class="p">,</span> <span class="n">CL_FALSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frame_bytes</span><span class="p">,</span> <span class="n">outFrame</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">iteration_events</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_event</span><span class="p">);</span>
 <span class="n">iteration_events</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">read_event</span><span class="p">);</span>
</pre></div>
</div>
<p>Here you added the <code class="docutils literal notranslate"><span class="pre">task_event</span></code> object to the end of the <code class="docutils literal notranslate"><span class="pre">iteration_events</span></code> vector. Then, you pass <code class="docutils literal notranslate"><span class="pre">iteration_events</span></code> in as the second to the last argument to the <code class="docutils literal notranslate"><span class="pre">enqueueReadBuffer</span></code> call. You could also have created a new vector because the <code class="docutils literal notranslate"><span class="pre">enqueueTask</span></code> call depends on the previous call.</p>
</li>
<li><p>You need to make sure that <code class="docutils literal notranslate"><span class="pre">ffmpeg</span></code> does not write to the output stream before you transfer the data back to the host. You can block the thread from continuing by calling the wait call on the <code class="docutils literal notranslate"><span class="pre">read_event</span></code> object. Add this line after the <code class="docutils literal notranslate"><span class="pre">push_back</span></code> function call on the <code class="docutils literal notranslate"><span class="pre">iteration_events</span></code> object.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">read_event</span><span class="o">.</span><span class="n">wait</span><span class="p">();</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="using-multiple-compute-units">
<h2>Using Multiple Compute Units<a class="headerlink" href="#using-multiple-compute-units" title="Permalink to this headline">¶</a></h2>
<p>In previous labs, only one CU is used for the kernel. In this section, you will modify the design to use multiple CUs, and each CU will process a smaller region of the image. To achieve that, you are going to make further modifications based on the output from the previous step.</p>
<blockquote>
<div><p><strong>TIP:</strong> The completed kernel source file is provided under the <code class="docutils literal notranslate"><span class="pre">reference-files/multicu</span></code> folder. You can use it as a reference if needed.</p>
</div></blockquote>
<p>Here you are going to modify the kernel code. Open the <code class="docutils literal notranslate"><span class="pre">convolve_fpga.cpp</span></code> file from <code class="docutils literal notranslate"><span class="pre">src/multicu</span></code>, and make following modifications:</p>
<ol>
<li><p>Modify the signature of the <code class="docutils literal notranslate"><span class="pre">convolve_fpga</span></code> kernel to accept the offset and number of lines each kernel will process (line 106).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>        <span class="n">void</span> <span class="n">convolve_fpga</span><span class="p">(</span><span class="n">const</span> <span class="n">RGBPixel</span><span class="o">*</span> <span class="n">inFrame</span><span class="p">,</span> <span class="n">RGBPixel</span><span class="o">*</span> <span class="n">outFrame</span><span class="p">,</span> <span class="n">const</span> <span class="nb">float</span><span class="o">*</span> <span class="n">coefficient</span><span class="p">,</span> <span class="nb">int</span> <span class="n">coefficient_size</span><span class="p">,</span> <span class="nb">int</span> <span class="n">img_width</span><span class="p">,</span> <span class="nb">int</span> <span class="n">img_height</span><span class="p">,</span> <span class="nb">int</span> <span class="n">line_offset</span><span class="p">,</span> <span class="nb">int</span> <span class="n">num_lines</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">...</span>
</pre></div>
</div>
<p>Depending on the image size and the number of CUs, you will divide the work evenly, and the offset will be used to determine the starting location of the kernel. The <code class="docutils literal notranslate"><span class="pre">line_offset</span></code> parameter is the first line that the CU will process. The <code class="docutils literal notranslate"><span class="pre">num_lines</span></code> argument will hold the number of lines processed by each CU.</p>
<blockquote>
<div><p><strong>TIP</strong>: Ensure the declaration of the <code class="docutils literal notranslate"><span class="pre">convolve_fpga</span></code> function in <code class="docutils literal notranslate"><span class="pre">kernels.h</span></code> matches with the <code class="docutils literal notranslate"><span class="pre">convolve_fpga.cpp</span></code> file.</p>
</div></blockquote>
</li>
<li><p>Modify the main kernel, so that you can calculate the padding and offsets for each of the CUs to process (line 123).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>     <span class="nb">int</span> <span class="n">half</span> <span class="o">=</span> <span class="n">COEFFICIENT_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

     <span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">RGBPixel</span><span class="o">&gt;</span> <span class="n">read_stream</span><span class="p">(</span><span class="s2">&quot;read&quot;</span><span class="p">);</span>
     <span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">RGBPixel</span><span class="o">&gt;</span> <span class="n">write_stream</span><span class="p">(</span><span class="s2">&quot;write&quot;</span><span class="p">);</span>

     <span class="nb">int</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">img_width</span> <span class="o">*</span> <span class="n">num_lines</span><span class="p">;</span>
     <span class="nb">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">std</span><span class="p">::</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">line_offset</span> <span class="o">-</span> <span class="n">half</span><span class="p">)</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">;</span>
     <span class="nb">int</span> <span class="n">top_padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="nb">int</span> <span class="n">bottom_padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="nb">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="k">if</span><span class="p">(</span><span class="n">line_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">top_padding</span> <span class="o">=</span> <span class="n">half</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">;</span>
     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">padding</span> <span class="o">=</span> <span class="n">img_width</span> <span class="o">*</span>  <span class="n">half</span><span class="p">;</span>
     <span class="p">}</span>
     <span class="k">if</span><span class="p">(</span><span class="n">line_offset</span> <span class="o">+</span> <span class="n">num_lines</span> <span class="o">&lt;</span> <span class="n">img_height</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">padding</span> <span class="o">+=</span> <span class="n">img_width</span> <span class="o">*</span> <span class="n">half</span> <span class="o">+</span> <span class="n">COEFFICIENT_SIZE</span><span class="p">;</span>
     <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
         <span class="n">bottom_padding</span> <span class="o">=</span> <span class="n">img_width</span> <span class="o">*</span> <span class="p">(</span><span class="n">half</span><span class="p">)</span> <span class="o">+</span> <span class="n">COEFFICIENT_SIZE</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="c1">#pragma HLS dataflow</span>
     <span class="n">read_dataflow</span><span class="p">(</span><span class="n">read_stream</span><span class="p">,</span> <span class="n">inFrame</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">img_width</span><span class="p">,</span> <span class="n">elements</span> <span class="o">+</span> <span class="n">padding</span><span class="p">,</span> <span class="n">half</span><span class="p">,</span> <span class="n">top_padding</span><span class="p">,</span> <span class="n">bottom_padding</span><span class="p">);</span>
     <span class="n">compute_dataflow</span><span class="p">(</span><span class="n">write_stream</span><span class="p">,</span> <span class="n">read_stream</span><span class="p">,</span> <span class="n">coefficient</span><span class="p">,</span> <span class="n">img_width</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">half</span><span class="p">);</span>
     <span class="n">write_dataflow</span><span class="p">(</span><span class="n">outFrame</span> <span class="o">+</span> <span class="n">line_offset</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">,</span> <span class="n">write_stream</span><span class="p">,</span> <span class="n">elements</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">offset</span></code> variable is used to calculate the offsets from the beginning of the image to the first pixel that the CU will read.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">top_padding</span></code> and <code class="docutils literal notranslate"><span class="pre">bottom_padding</span></code> variables will determine the padding of zeros to add to the top and the bottom of the image.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">padding</span></code> variable, on the other hand, is the number of pixels to read including the regions around the convolution window.</p></li>
</ul>
</li>
<li><p>Modify the read_dataflow kernel to send zeros for the padding areas for the top and the bottom of the image (line 20).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>     <span class="n">void</span> <span class="n">read_dataflow</span><span class="p">(</span><span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">RGBPixel</span><span class="o">&gt;&amp;</span> <span class="n">read_stream</span><span class="p">,</span> <span class="n">const</span> <span class="n">RGBPixel</span> <span class="o">*</span> <span class="ow">in</span><span class="p">,</span> <span class="nb">int</span> <span class="n">img_width</span><span class="p">,</span> <span class="nb">int</span> <span class="n">elements</span><span class="p">,</span> <span class="nb">int</span> <span class="n">half</span><span class="p">,</span> <span class="nb">int</span> <span class="n">top_padding</span><span class="p">,</span> <span class="nb">int</span> <span class="n">bottom_padding</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">while</span><span class="p">(</span><span class="n">top_padding</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
             <span class="n">read_stream</span> <span class="o">&lt;&lt;</span> <span class="n">zero</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="nb">int</span> <span class="n">pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="k">while</span><span class="p">(</span><span class="n">elements</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
             <span class="n">read_stream</span> <span class="o">&lt;&lt;</span> <span class="ow">in</span><span class="p">[</span><span class="n">pixel</span><span class="o">++</span><span class="p">];</span>
         <span class="p">}</span>
         <span class="k">while</span><span class="p">(</span><span class="n">bottom_padding</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
             <span class="n">read_stream</span> <span class="o">&lt;&lt;</span> <span class="n">zero</span><span class="p">;</span>
         <span class="p">}</span>
     <span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Because you are handling the padding logic in the read_dataflow module, you can remove the initialization logic for zeroing out the padded area. Remove the following lines from compute_dataflow (line 45).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>     <span class="k">while</span><span class="p">(</span><span class="n">line_idx</span> <span class="o">&lt;</span> <span class="n">center</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">for</span><span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">img_width</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
             <span class="n">window_mem</span><span class="p">[</span><span class="n">line_idx</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero</span><span class="p">;</span>
         <span class="p">}</span>
             <span class="n">line_idx</span><span class="o">++</span><span class="p">;</span>
     <span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
<p>You still need to modify a few things on the host code side to launch multiple CUs in parallel.</p>
</div>
<div class="section" id="host-code-updates-to-support-multiple-compute-units">
<h2>Host Code Updates to Support Multiple Compute Units<a class="headerlink" href="#host-code-updates-to-support-multiple-compute-units" title="Permalink to this headline">¶</a></h2>
<p>The following steps need to be performed for supporting CUs.</p>
<ol>
<li><p>Open <code class="docutils literal notranslate"><span class="pre">convolve.cpp</span></code> and add the following lines before the <code class="docutils literal notranslate"><span class="pre">frame_count</span></code> <code class="docutils literal notranslate"><span class="pre">for</span></code> loop.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>     <span class="nb">int</span> <span class="n">compute_units</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
     <span class="nb">int</span> <span class="n">lines_per_compute_unit</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="n">compute_units</span><span class="p">;</span>
</pre></div>
</div>
<p>These variables define the number of CUs you will have in your binary. You then divide the lines of the image evenly between the CUs. This code assumes that you can evenly divide the image among the CUs.</p>
</li>
<li><p>Instead of launching one task, launch a task on each of the CUs you created. Modify the following code from:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>     <span class="n">cl</span><span class="p">::</span><span class="n">Event</span> <span class="n">task_event</span><span class="p">;</span>
     <span class="n">q</span><span class="o">.</span><span class="n">enqueueTask</span><span class="p">(</span><span class="n">convolve_kernel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iteration_events</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">task_event</span><span class="p">);</span>
</pre></div>
</div>
<p>to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>     <span class="n">vector</span><span class="o">&lt;</span><span class="n">cl</span><span class="p">::</span><span class="n">Event</span><span class="o">&gt;</span> <span class="n">task_events</span><span class="p">;</span>
     <span class="k">for</span><span class="p">(</span><span class="nb">int</span> <span class="n">cu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cu</span> <span class="o">&lt;</span> <span class="n">compute_units</span><span class="p">;</span> <span class="n">cu</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">cl</span><span class="p">::</span><span class="n">Event</span> <span class="n">task_event</span><span class="p">;</span>
         <span class="n">convolve_kernel</span><span class="o">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">cu</span> <span class="o">*</span> <span class="n">lines_per_compute_unit</span><span class="p">);</span>
         <span class="n">convolve_kernel</span><span class="o">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">lines_per_compute_unit</span><span class="p">);</span>
         <span class="n">q</span><span class="o">.</span><span class="n">enqueueTask</span><span class="p">(</span><span class="n">convolve_kernel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iteration_events</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">task_event</span><span class="p">);</span>
         <span class="n">task_events</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">task_event</span><span class="p">);</span>
     <span class="p">}</span>
     <span class="n">copy</span><span class="p">(</span><span class="n">begin</span><span class="p">(</span><span class="n">task_events</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">task_events</span><span class="p">),</span> <span class="n">std</span><span class="p">::</span><span class="n">back_inserter</span><span class="p">(</span><span class="n">iteration_events</span><span class="p">));</span>
</pre></div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">for</span></code> loop will launch one task per CU. You will pass an event object to each of the tasks, and then add it to the <code class="docutils literal notranslate"><span class="pre">task_events</span></code> vector. Notice that you are not adding it to the <code class="docutils literal notranslate"><span class="pre">iteration_events</span></code> until after the end of the loop. This is because you only want the tasks to depend on the <code class="docutils literal notranslate"><span class="pre">enqueueWriteBuffer</span></code> call and not each other.</p>
</li>
</ol>
<p>Now you can compile and run the design, and you should see results similar to the following section.</p>
</div>
<div class="section" id="run-hardware-emulation-for-multiple-compute-units">
<h2>Run Hardware Emulation for Multiple Compute Units<a class="headerlink" href="#run-hardware-emulation-for-multiple-compute-units" title="Permalink to this headline">¶</a></h2>
<ol>
<li><p>Before running emulation, you need to set the CU number to 4. To do that, open the <code class="docutils literal notranslate"><span class="pre">design.cfg</span></code> and modify the <code class="docutils literal notranslate"><span class="pre">nk</span></code> option as follows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nk</span><span class="o">=</span><span class="n">convolve_fpga</span><span class="p">:</span><span class="mi">4</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">nk</span></code> option is used to specify the number of kernel instances, or CUs, generated during the linking step of the build process. For this lab, set it to 4.</p>
</li>
<li><p>Go to the <code class="docutils literal notranslate"><span class="pre">makefile</span></code> directory.</p></li>
<li><p>Use the following command to run hardware emulation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">run</span> <span class="n">TARGET</span><span class="o">=</span><span class="n">hw_emu</span> <span class="n">STEP</span><span class="o">=</span><span class="n">multicu</span> <span class="n">SOLUTION</span><span class="o">=</span><span class="mi">1</span> <span class="n">NUM_FRAMES</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>The following code shows the results of this kernel running on four CUs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Processed</span> <span class="mf">0.08</span> <span class="n">MB</span> <span class="ow">in</span> <span class="mf">42.810</span><span class="n">s</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">MBps</span><span class="p">)</span>

<span class="n">INFO</span><span class="p">:</span> <span class="p">[</span><span class="n">Vitis</span><span class="o">-</span><span class="n">EM</span> <span class="mi">22</span><span class="p">]</span> <span class="p">[</span><span class="n">Wall</span> <span class="n">clock</span> <span class="n">time</span><span class="p">:</span> <span class="mi">01</span><span class="p">:</span><span class="mi">34</span><span class="p">,</span> <span class="n">Emulation</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.102462</span> <span class="n">ms</span><span class="p">]</span> <span class="n">Data</span> <span class="n">transfer</span> <span class="n">between</span> <span class="n">kernel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="k">global</span> <span class="n">memory</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">convolve_fpga_1</span><span class="p">:</span><span class="n">m_axi_gmem1</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">24.012</span> <span class="n">KB</span>              <span class="n">WR</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>
<span class="n">convolve_fpga_1</span><span class="p">:</span><span class="n">m_axi_gmem2</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>               <span class="n">WR</span> <span class="o">=</span> <span class="mf">20.000</span> <span class="n">KB</span>
<span class="n">convolve_fpga_1</span><span class="p">:</span><span class="n">m_axi_gmem3</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">0.035</span> <span class="n">KB</span>               <span class="n">WR</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>
<span class="n">convolve_fpga_2</span><span class="p">:</span><span class="n">m_axi_gmem1</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">22.012</span> <span class="n">KB</span>              <span class="n">WR</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>
<span class="n">convolve_fpga_2</span><span class="p">:</span><span class="n">m_axi_gmem2</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>               <span class="n">WR</span> <span class="o">=</span> <span class="mf">20.000</span> <span class="n">KB</span>
<span class="n">convolve_fpga_2</span><span class="p">:</span><span class="n">m_axi_gmem3</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">0.035</span> <span class="n">KB</span>               <span class="n">WR</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>
<span class="n">convolve_fpga_3</span><span class="p">:</span><span class="n">m_axi_gmem1</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">24.012</span> <span class="n">KB</span>              <span class="n">WR</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>
<span class="n">convolve_fpga_3</span><span class="p">:</span><span class="n">m_axi_gmem2</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>               <span class="n">WR</span> <span class="o">=</span> <span class="mf">20.000</span> <span class="n">KB</span>
<span class="n">convolve_fpga_3</span><span class="p">:</span><span class="n">m_axi_gmem3</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">0.035</span> <span class="n">KB</span>               <span class="n">WR</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>
<span class="n">convolve_fpga_4</span><span class="p">:</span><span class="n">m_axi_gmem1</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">22.000</span> <span class="n">KB</span>              <span class="n">WR</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>
<span class="n">convolve_fpga_4</span><span class="p">:</span><span class="n">m_axi_gmem2</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>               <span class="n">WR</span> <span class="o">=</span> <span class="mf">20.000</span> <span class="n">KB</span>
<span class="n">convolve_fpga_4</span><span class="p">:</span><span class="n">m_axi_gmem3</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">0.035</span> <span class="n">KB</span>               <span class="n">WR</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>
</pre></div>
</div>
<p>You can now perform four times more work in about the same amount of time. You transfer more data from global memory because each CU needs to read the surrounding padding lines.</p>
</li>
</ol>
</div>
<div class="section" id="view-profile-summary-report-for-hardware-emulation">
<h2>View Profile Summary Report for Hardware Emulation<a class="headerlink" href="#view-profile-summary-report-for-hardware-emulation" title="Permalink to this headline">¶</a></h2>
<p>Use the following command to view the Profile Summary report.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">view_run_summary</span> <span class="n">TARGET</span><span class="o">=</span><span class="n">hw_emu</span> <span class="n">STEP</span><span class="o">=</span><span class="n">multicu</span>
</pre></div>
</div>
<p>The kernel execution time for four CUs is around 0.065 ms each.</p>
<p>Here is the updated table.</p>
<p>| Step                    | Image Size | Time (HW-EM)(ms) | Reads (KB)      | Writes (KB)    | Avg. Read (KB) | Avg. Write (KB) | BW (MBps)  |
| :——————-    | :——— | —————: | ————–: | ————-: | ————-: | ————–: | ———: |
| baseline                |     512x10 | 3.903            | 344             |        20.0    |          0.004 |           0.004 |    5.2     |
| localbuf                |     512x10 | 1.574 (2.48x)    | 21 (0.12x)      |        20.0    |          0.064 |           0.064 |    13      |
| fixed-type data         |     512x10 | 0.46 (3.4x)      | 21              |        20.0    |          0.064 |           0.064 |    44      |
| dataflow                |     512x10 | 0.059 (7.8x)     | 21              |        20.0    |          0.064 |           0.064 |    347     |
| multi-CU                |     512x40*| 0.06 (0.98x)     | 92 (4.3x)       |       80.0 (4x)|          0.064 |           0.064 |    1365*   |</p>
<blockquote>
<div><p><strong>NOTE:</strong></p>
<ul class="simple">
<li><p>The multi-CU version processed four times the amount of data compared to previous versions. Even if the CU execution time does not change for each CU, the four parallel CUs increase the system performance by almost four times.</p></li>
<li><p>This is calculated by 4x data/time. Here the data transfer time is not accounted for, and you assume that the four CUs are executing in parallel. This is not as accurate as the hardware run, but you will use it as a reference for optimizations effectiveness.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<p>In this step, you performed host code optimizations by using out-of-order command queue and executing multiple CUs. In the next step, you will be <a class="reference internal" href="qdma.html"><span class="doc">Using QDMA Streaming with Multiple Compute Units</span></a>.</p>
<p></br></p>
<hr/>
<p align="center" class="sphinxhide"><b><a href="/docs/vitis-getting-started/README.md">Return to Getting Started Pathway</a> — <a href="/docs/convolution-tutorial/README.md">Return to Start of Tutorial</a></b></p><p align="center" class="sphinxhide"><sup>Copyright&copy; 2020 Xilinx</sup></p></div>
</div>


           </div>
           
          </div>
          <footer>
<!-- Atalwar: Moved the footer code to layout.html to resolve conflict with the Xilinx template -->
</footer>

        </div>
      </div>
	  
	  
	  <!-- Sphinx Page Footer block -->
  

  <hr/>

  <div role="contentinfo" class="copyright">
    <p class="footerinfo">
      <span class="lastupdated">
        Last updated on July 23, 2020.
      </span>

    </p>
  </div>	  
      </div>
    </section>


  




  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

   <script type="text/javascript">
    jQuery(function() { Search.loadIndex("searchindex.js"); });
  </script>

  <script type="text/javascript" id="searchindexloader"></script>     	    
	    
	    
  
  
    
  
  

  
  <!--  Xilinx template footer block -->
							</div>
						</div>
					</div>
				</div>
				<div class="xilinxExperienceFragments experiencefragment aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
					<div class="xf-content-height">
						<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
							<div class="footer parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
								<noindex>
									<footer>
										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">
													<div class="row">
														<div class="footerSocial parbase">
															<div class="col-md-push-6 col-lg-push-6 col-md-6 col-lg-6">
																<ul class="list-inline pull-right social-menu">
																	<li>
																		<a href="https://www.linkedin.com/company/xilinx">
																		<span class="linkedin icon"></span>
																		<span class="sr-only">Connect on LinkedIn</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.twitter.com/XilinxInc">
																		<span class="twitter icon"></span>
																		<span class="sr-only">Follow us on Twitter</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.facebook.com/XilinxInc">
																		<span class="facebook icon"></span>
																		<span class="sr-only">Connect on Facebook</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.youtube.com/XilinxInc">
																		<span class="youtube icon"></span>
																		<span class="sr-only">Watch us on YouTube</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.xilinx.com/registration/subscriber-signup.html">
																		<span class="newsletter icon"></span>
																		<span class="sr-only">Subscribe to Newsletter</span>
																		</a>
																	</li>
																</ul>
															</div>
														</div>
														<div class="col-md-pull-6 col-lg-pull-6 col-md-6 col-lg-6">
															<span class="copyright">
                                  
                                  &copy; 2020, Xilinx
                              </span>
															<ul class="list-inline sub-menu">
																<li>
																	<a href="https://www.xilinx.com/about/privacy-policy.html">Privacy</a>
																</li>
																<li>
																	<a href="https://www.xilinx.com/about/legal.html">Legal</a>
																</li>
																<li>
																	<a href="https://www.xilinx.com/about/contact.html">Contact</a>
																</li>
															</ul>
														</div>
													</div>
												</div>
											</div>
										</div>
									</footer>
								</noindex>
							</div>
						</div>
					</div>
				</div>
				<div class="quicklinks parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
					<noindex>
						<span class="quickLinks">
							<ul>
								<li>
									<a href="#top" class="btn backToTop">
									<span class="fas fa-angle-up" aria-hidden="true"></span>
									</a>
								</li>
							</ul>
						</span>
					</noindex>
				</div>
			</div>
		</div>
		<script>window.CQ = window.CQ || {}</script>
		<script src="https://static.cloud.coveo.com/searchui/v2.4382/js/CoveoJsSearch.Lazy.min.js"></script>
		<script>
			var underscoreSetup = function () {
			  _.templateSettings.interpolate = /\{\{=([^-][\S\s]+?)\}\}/g;
			  _.templateSettings.evaluate = /\{\{([^-=][\S\s]+?)\}\}/g;
			  _.templateSettings.escape = /\{\{-([^=][\S\s]+?)\}\}/g;
			}
			
			underscoreSetup();
		</script>
	</body>
</html>